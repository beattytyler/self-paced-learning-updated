<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ subject_info.name }} - Learning Platform</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Pyodide for Python code execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <!-- Markdown rendering and sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body data-subject="{{ subject }}">
    <header>
      <div class="header-content">
        <div class="header-actions">
          <div class="breadcrumb-section">
            <div class="breadcrumb">
              <a href="/">Learning Platform</a>
              <span class="separator">›</span>
              <span class="current">{{ subject_info.name }}</span>
            </div>
            <h1>
              <i
                class="{{ subject_info.icon }}"
                style="color: {{ subject_info.color }};"
              ></i>
              {{ subject_info.name }}
            </h1>
            <p class="subtitle">{{ subject_info.description }}</p>
          </div>

          <!-- Admin Override Indicator -->
          <div
            class="admin-override-indicator-wrapper{% if not admin_override %} is-hidden{% endif %}"
          >
            <div
              id="adminOverrideIndicator"
              class="admin-override-indicator {% if admin_override %}active{% endif %}"
              data-active="{{ 'true' if admin_override else 'false' }}"
              title="Admin override status"
            >
              <i class="fas fa-shield-alt"></i>
              <span id="adminOverrideIndicatorText">
                {% if admin_override %}Admin Override Active{% else %}Admin
                Override Off{% endif %}
              </span>
            </div>
          </div>
          {% if token_balance is not none %}
          <div class="token-badge" id="tokenBalanceBadge" data-balance="{{ token_balance }}">
            <i class="fas fa-coins"></i>
            <span id="tokenBalanceValue">{{ token_balance }}</span>
          </div>
          {% endif %}
        </div>
      </div>
    </header>

    <div class="topics-grid">
      {% for subtopic_id, subtopic_data in subtopics.items() %}
      <div
        class="topic-card"
        id="{{ subtopic_id }}-card"
        data-subject="{{ subject }}"
        data-subtopic="{{ subtopic_id }}"
        data-has-quiz="{{ 'true' if subtopic_data.question_count > 0 else 'false' }}"
        data-lesson-count="{{ subtopic_data.lesson_count }}"
        data-video-count="{{ subtopic_data.video_count }}"
        data-total-count="{{ subtopic_data.lesson_count + subtopic_data.video_count }}"
      >
        <div
          class="topic-header"
          style="background: linear-gradient(135deg, {{ subject_info.color }} 0%, {{ subject_info.color }}cc 50%, {{ subject_info.color }}ee 100%); box-shadow: 0 4px 8px {{ subject_info.color }}33;"
        >
          <h3>{{ subtopic_data.name }}</h3>
          <span class="completion-badge{% if subtopic_data.status == 'inactive' %} badge-unavailable{% elif subtopic_data.status == 'active' %} badge-available{% else %} badge-locked{% endif %}" id="{{ subtopic_id }}-badge">
            {% if subtopic_data.status == 'inactive' %}
            <i class="fas fa-ban"></i> Unavailable
            {% elif subtopic_data.status == 'active' %}
            <i class="fas fa-check-circle"></i> Available
            {% else %}
            <i class="fas fa-lock"></i> Locked
            {% endif %}
          </span>
        </div>
        <div class="topic-content">
          {% if subtopic_data.status == 'inactive' %}
          <div class="inactive-notice">
            <i class="fas fa-info-circle"></i>
            <p>This topic is currently unavailable. Please check back later or contact your instructor.</p>
          </div>
          {% else %}
          <p class="topic-description">{{ subtopic_data.description }}</p>

          {% if subtopic_data.prerequisites %}
          <div class="prerequisites">
            <i class="fas fa-lock"></i>
            <span class="prereq-text"
              >Prerequisites: {{ subtopic_data.prerequisites | join(', ')
              }}</span
            >
          </div>
          {% endif %} {% set lesson_count = subtopic_data.lesson_count %} {% set
          video_count = subtopic_data.video_count %} {% set total_items =
          lesson_count + video_count %} {% set progress_data =
          subtopic_data.progress or {} %} {% set lesson_stats =
          progress_data.lessons or {} %} {% set video_stats =
          progress_data.videos or {} %} {% set overall_stats =
          progress_data.overall or {} %} {% set completed_lessons =
          lesson_stats.completed_count if lesson_stats.completed_count is not
          none else (lesson_stats.completed_lessons | length if
          lesson_stats.completed_lessons is defined else 0) %} {% set
          completed_videos = video_stats.watched_count if
          video_stats.watched_count is not none else (video_stats.watched_videos
          | length if video_stats.watched_videos is defined else 0) %} {% set
          descriptor_parts = [] %} {% if lesson_count > 0 %} {% set
          descriptor_parts = descriptor_parts + ['lessons'] %} {% endif %} {% if
          video_count > 0 %} {% set descriptor_parts = descriptor_parts +
          ['videos'] %} {% endif %} {% set descriptor = 'lessons and videos' if
          descriptor_parts | length > 1 else (descriptor_parts[0] if
          descriptor_parts | length == 1 else 'content') %} {% set
          completion_percentage = overall_stats.completion_percentage or 0 %} {%
          set completion_percentage = 0 if completion_percentage is none else
          completion_percentage %} {% if completion_percentage < 0 %} {% set
          completion_percentage = 0 %} {% elif completion_percentage > 100 %} {%
          set completion_percentage = 100 %} {% endif %} {% set status_text =
          'All ' ~ descriptor ~ ' complete' if completion_percentage >= 100 else
          (completion_percentage | round(0, 'floor')) ~ '% of ' ~ descriptor ~ '
          complete' %} {% set sr_segments = [] %} {% if lesson_count > 0 %} {%
          set sr_segments = sr_segments + [(completed_lessons | default(0)) ~ '
          of ' ~ lesson_count ~ ' lessons'] %} {% endif %} {% if video_count > 0
          %} {% set sr_segments = sr_segments + [(completed_videos | default(0))
          ~ ' of ' ~ video_count ~ ' videos'] %} {% endif %} {% set sr_summary =
          (sr_segments | join(' and ')) ~ ' complete' if sr_segments else 'No
          learning items completed yet' %} {% if total_items > 0 %}
          <div
            class="progress-container"
            data-progress="overall"
            aria-hidden="false"
          >
            <span id="{{ subtopic_id }}-progress-text" class="sr-only"
              >Progress update: {{ sr_summary }}. Overall status: {{ status_text
              }}.</span
            >
            <div
              class="progress-bar{% if completion_percentage >= 100 %} is-complete{% endif %}"
              id="{{ subtopic_id }}-progress"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-valuenow="{{ '%.0f' | format(completion_percentage) }}"
              aria-valuetext="{{ status_text }}"
              aria-describedby="{{ subtopic_id }}-progress-text"
              style="width: {{ '%.2f' | format(completion_percentage) }}%;"
            ></div>
          </div>
          {% endif %}

          <div class="topic-actions">
            {% if subtopic_data.lesson_count > 0 %}
            <button
              class="button lesson-btn"
              data-subtopic="{{ subtopic_id }}"
              onclick="handleSubtopicAccess('{{ subject }}', '{{ subtopic_id }}')"
              {% if subtopic_data.status == 'inactive' %}
              disabled
              style="opacity: 0.5; cursor: not-allowed;"
              {% endif %}
            >
              <i class="fas fa-book-open"></i>
              {% if subtopic_data.status == 'inactive' %}
              Unavailable
              {% else %}
              View Lessons
              {% endif %}
            </button>
            {% endif %}
          </div>
        {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Initial Learning Layout (Sidebar Style) -->
    <div
      class="blackboard-layout"
      id="initial-learning-layout"
      style="display: none"
    >
      <nav id="initial-sidebar" class="sidebar">
        <div class="sidebar-header">
          <h2 id="initial-learning-title">Initial Learning</h2>
          <p id="initial-learning-subtitle">
            Learn new concepts step by step with lessons and videos.
          </p>
        </div>

        <ul id="initial-topics-nav" class="topic-nav-list">
          <!-- Lessons and videos will be populated here -->
        </ul>

        <div class="sidebar-footer">
          <button
            id="sidebar-quiz-btn"
            class="lesson-quiz-btn sidebar"
            data-show-locked="true"
            style="display: none"
            onclick="handleQuizAccess(currentSubject, currentSubtopic)"
            disabled
          >
            <i class="fas fa-brain"></i>
            <span>Take Quiz</span>
          </button>
          <button
            id="backToTopicsFromInitial"
            class="action-button"
            onclick="backToTopicsFromInitial()"
          >
            <i class="fas fa-arrow-left"></i>
            Back to Topics
          </button>
        </div>
      </nav>

      <main id="initial-content-area" class="content-area">
        <div id="initial-content-display">
          <div id="initial-welcome" class="welcome-message">
            <h2>Welcome to Initial Learning</h2>
            <p>Select a lesson or video from the sidebar to begin learning.</p>
          </div>
        </div>
      </main>
    </div>

    <!-- Video Modal -->
    <div class="video-container" id="video-modal">
      <div class="modal-content">
        <div class="close-button">×</div>
        <h2 class="video-title" id="current-video-title">Video Title</h2>
        <div class="video-player">
          <iframe
            id="video-iframe"
            width="800"
            height="450"
            src=""
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
          <div class="progress-container" style="margin-top: 10px">
            <div class="progress-bar" id="video-progress-bar"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lesson Selector Modal -->
    <div class="lesson-modal" id="lesson-modal" style="display: none">
      <div class="lesson-modal-content">
        <div class="lesson-modal-header">
          <h2 id="lesson-modal-title">Initial Lessons - Integrals</h2>
          <button class="close-lesson-modal" onclick="closeLessonModal()">
            ×
          </button>
        </div>
        <div class="lesson-modal-body">
          <div class="lesson-type-selector" style="display: none">
            <button
              class="lesson-type-btn remedial-btn"
              onclick="showLessons('remedial')"
            >
              <i class="fas fa-bandage"></i>
              <div class="lesson-type-info">
                <h3>Remedial Lessons</h3>
                <p>Review and strengthen understanding of weak topics</p>
              </div>
            </button>
            <button
              class="lesson-type-btn initial-btn"
              onclick="showLessons('initial')"
            >
              <i class="fas fa-seedling"></i>
              <div class="lesson-type-info">
                <h3>Initial Lessons</h3>
                <p>Learn new topics and concepts from the beginning</p>
              </div>
            </button>
            <button
              class="lesson-type-btn all-btn"
              onclick="showLessons('all')"
            >
              <i class="fas fa-list"></i>
              <div class="lesson-type-info">
                <h3>All Lessons</h3>
                <p>View all available lessons for this topic</p>
              </div>
            </button>
          </div>
          <div class="lesson-list" id="lesson-list">
            <div class="lesson-list-header">
              <h3 id="lesson-list-title">Available Initial Lessons</h3>
              <button
                id="lesson-quiz-btn-list"
                class="lesson-quiz-btn"
                style="display: none"
                onclick="handleQuizAccess(currentSubject, currentSubtopic)"
              >
                <i class="fas fa-brain"></i> Take Quiz
              </button>
            </div>
            <div class="lesson-items" id="lesson-items">
              <!-- Lessons will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lesson Viewer Modal -->
    <div
      class="lesson-viewer-modal"
      id="lesson-viewer-modal"
      style="display: none"
    >
      <div class="lesson-viewer-content">
        <div class="lesson-viewer-header">
          <button class="back-to-lessons-btn" onclick="backToLessonList()">
            <i class="fas fa-arrow-left"></i> Back to Lessons
          </button>
          <h2 id="lesson-viewer-title">Lesson Title</h2>
          <div class="lesson-viewer-actions">
            <span
              id="lesson-completed-indicator-header"
              class="lesson-completed-indicator"
              style="display: none"
            >
              <i class="fas fa-check-circle"></i> Completed
            </span>
            <button
              id="lesson-quiz-btn"
              class="lesson-quiz-btn"
              style="display: none"
              onclick="handleQuizAccess(currentSubject, currentSubtopic)"
            >
              <i class="fas fa-brain"></i> Take Quiz
            </button>
            <button class="close-lesson-viewer" onclick="closeLessonViewer()">
              ×
            </button>
          </div>
        </div>
        <div class="lesson-viewer-body" id="lesson-viewer-body">
          <!-- Lesson content will be loaded here -->
        </div>
        <div
          id="lesson-quiz-requirements"
          class="quiz-requirements compact"
          style="display: none"
        >
          <div class="requirement-item">
            <i class="req-icon lessons-icon fas fa-book"></i>
            <span class="req-text">Complete all lessons</span>
            <span class="req-status lessons-status">-</span>
          </div>
          <div class="requirement-item">
            <i class="req-icon video-icon fas fa-play"></i>
            <span class="req-text">Watch required videos</span>
            <span class="req-status video-status">-</span>
          </div>
        </div>
      </div>
    </div>

    <style>
      .header-content {
        text-align: center;
        max-width: 800px;
        margin: 0 auto;
      }

      .breadcrumb {
        margin-bottom: 1rem;
        color: #666;
      }

      .breadcrumb a {
        color: #007bff;
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      .separator {
        margin: 0 0.5rem;
      }

      .current {
        color: #333;
        font-weight: 600;
      }

      .prerequisites {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
        padding: 0.5rem 0.75rem;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #856404;
        text-align: center;
      }

      .inactive-notice {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin: 1.5rem 0;
        padding: 1rem 1.25rem;
        background: #fee;
        border: 2px solid #fcc;
        border-radius: 8px;
        font-size: 1rem;
        color: #c53030;
        text-align: center;
      }

      .inactive-notice i {
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .inactive-notice p {
        margin: 0;
        line-height: 1.5;
      }

      .prereq-text {
        display: inline-block;
        line-height: 1.4;
      }

      .topic-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      /* Modern Button Styling */
      .watch-btn,
      .quiz-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 150px;
        height: 44px;
        justify-content: center;
        letter-spacing: 0.025em;
        box-sizing: border-box;
        flex-shrink: 0;
      }

      .watch-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .watch-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1ea080 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .quiz-btn {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        color: white;
        text-decoration: none;
      }

      .quiz-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #5a0fc8 100%);
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }

      /* Icon styling within buttons */
      .watch-btn i,
      .quiz-btn i {
        font-size: 1rem;
        opacity: 0.9;
      }

      /* Quiz prerequisite states */
      .quiz-btn-disabled {
        background: #6c757d !important;
        cursor: not-allowed !important;
        opacity: 0.7;
        position: relative;
      }

      .quiz-btn-disabled:hover {
        background: #6c757d !important;
        transform: none !important;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2) !important;
      }

      .quiz-btn-ready {
        background: #28a745 !important;
        animation: readyPulse 2s infinite;
      }

      .quiz-btn-ready:hover {
        background: #218838 !important;
      }

      .quiz-btn-admin {
        background: #ffc107 !important;
        color: #212529 !important;
        animation: adminPulse 2s infinite;
      }

      .quiz-btn-admin:hover {
        background: #e0a800 !important;
      }

      @keyframes adminPulse {
        0% {
          box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }
        50% {
          box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        100% {
          box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }
      }

      /* Quiz requirements section */
      .quiz-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .quiz-requirements {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px 12px;
        width: 100%;
        max-width: 200px;
        font-size: 0.85rem;
      }

      .requirement-item {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 2px 0;
        padding: 2px 0;
      }

      .req-icon {
        width: 14px;
        font-size: 0.8rem;
        color: #6c757d;
      }

      .req-text {
        flex: 1;
        color: #495057;
      }

      .req-status {
        width: 14px;
        font-size: 0.8rem;
      }

      .req-status.complete {
        color: #28a745;
      }

      .req-status.incomplete {
        color: #dc3545;
      }

      .req-status.admin-override {
        color: #ffc107;
      }

      .quiz-status-icon {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        z-index: 1;
      }

      .quiz-status-icon.incomplete {
        background: #dc3545;
      }

      .quiz-status-icon.complete {
        background: #28a745;
      }

      .quiz-status-icon.admin-override {
        background: #ffc107;
        color: #212529;
      }

      @keyframes readyPulse {
        0% {
          box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }
        50% {
          box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        100% {
          box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }
      }

      /* Responsive design for smaller screens */
      @media (max-width: 768px) {
        .topic-actions {
          flex-direction: row;
          align-items: center;
          justify-content: center;
        }

        .watch-btn,
        .quiz-btn,
        .lesson-btn {
          width: 130px;
          height: 44px;
          font-size: 0.85rem;
        }
      }

      /* Admin Override Styles */
      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
      }

      .breadcrumb-section {
        flex: 1;
      }

      .admin-actions {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-left: 20px;
      }

      .admin-actions .action-btn.secondary {
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .admin-actions .action-btn.secondary:hover {
        background: #e9ecef;
        color: #495057;
      }

      .admin-actions .action-btn.secondary.override-active {
        background: #28a745;
        color: white;
        border-color: #28a745;
      }

      .admin-actions .action-btn.secondary.override-active:hover {
        background: #218838;
        border-color: #1e7e34;
      }

      /* Notification styles */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .header-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .admin-actions {
          margin-left: 0;
          margin-top: 15px;
          justify-content: center;
        }

        .topic-actions {
          flex-direction: row;
          justify-content: center;
        }
      }

      /* Lesson Modal Styles */
      .lesson-modal,
      .lesson-viewer-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .lesson-modal-content,
      .lesson-viewer-content {
        background: white;
        border-radius: 12px;
        max-width: 800px;
        max-height: 80vh;
        width: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .lesson-modal-header,
      .lesson-viewer-header {
        padding: 20px 30px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8f9fa;
        border-radius: 12px 12px 0 0;
      }

      .lesson-viewer-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .lesson-quiz-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease,
          background 0.2s ease;
        color: #fff;
        background: linear-gradient(135deg, #2563eb, #7c3aed);
      }

      .lesson-quiz-btn.sidebar {
        width: 100%;
        justify-content: center;
        margin-bottom: 12px;
      }

      .lesson-quiz-btn i {
        font-size: 0.95rem;
      }

      .lesson-quiz-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
      }

      .lesson-quiz-btn.locked,
      .lesson-quiz-btn.locked:hover {
        background: #6c757d !important;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        opacity: 0.85;
      }

      .lesson-quiz-btn.ready {
        background: linear-gradient(135deg, #218838, #1ea080) !important;
        box-shadow: 0 10px 22px rgba(33, 136, 56, 0.3);
      }

      .lesson-quiz-btn.ready:hover {
        box-shadow: 0 12px 26px rgba(33, 136, 56, 0.35);
      }

      .lesson-quiz-btn.admin {
        background: linear-gradient(135deg, #6f42c1, #4c1d95) !important;
        box-shadow: 0 10px 22px rgba(111, 66, 193, 0.3);
      }

      .lesson-quiz-btn:disabled {
        pointer-events: none;
      }

      .lesson-completed-indicator {
        color: #28a745;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.95rem;
      }

      .lesson-completion-icon {
        color: #28a745;
        margin-left: 8px;
      }

      .lesson-item.lesson-completed {
        background: linear-gradient(
          135deg,
          rgba(17, 24, 39, 0.95),
          rgba(6, 95, 70, 0.88)
        );
        border-left: 4px solid #10b981;
        box-shadow: 0 16px 36px rgba(6, 95, 70, 0.35);
        color: #f9fafb;
      }

      .lesson-item.lesson-completed:hover {
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.98),
          rgba(5, 150, 105, 0.92)
        );
        border-color: #34d399;
        transform: translateX(5px) translateY(-1px);
      }

      .lesson-item.lesson-completed .lesson-item-title {
        color: #ecfeff;
      }

      .lesson-item.lesson-completed .lesson-item-type {
        background: rgba(16, 185, 129, 0.15);
        color: #6ee7b7;
      }

      .lesson-item.lesson-completed .lesson-item-tags {
        color: #d1fae5;
      }

      .lesson-item.lesson-completed .lesson-tag {
        background: rgba(15, 118, 110, 0.35);
        color: #d1fae5;
      }

      .lesson-item.lesson-opened:not(.lesson-completed) {
        background: linear-gradient(
          135deg,
          #111827 0%,
          rgba(22, 101, 52, 0.92) 100%
        );
        border-left: 4px solid #16a34a;
        color: #f0fff4;
        box-shadow: 0 16px 32px rgba(15, 118, 110, 0.32);
      }

      .lesson-item.lesson-opened:not(.lesson-completed):hover {
        background: linear-gradient(
          135deg,
          #0f172a 0%,
          rgba(16, 185, 129, 0.95) 100%
        );
        border-color: #22c55e;
        transform: translateX(6px) translateY(-1px);
      }

      .lesson-item.lesson-opened .lesson-item-title {
        color: #ecfdf5;
      }

      .lesson-item.lesson-opened .lesson-item-type {
        background: rgba(16, 185, 129, 0.22);
        color: #bbf7d0;
      }

      .lesson-item.lesson-opened .lesson-tag {
        background: rgba(30, 64, 175, 0.25);
        color: #dbeafe;
      }

      .lesson-completion-trigger {
        height: 1px;
        width: 100%;
        margin-top: 20px;
      }

      .lesson-completion-section {
        margin-top: 30px;
        padding: 20px;
        border-top: 2px solid #e9ecef;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
        text-align: center;
      }

      .lesson-completion-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
      }

      .lesson-completed-indicator-bottom {
        color: #28a745;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        padding: 15px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
      }

      .lesson-completed-indicator-bottom i {
        font-size: 1.3rem;
      }

      .mark-complete-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
      }

      .mark-complete-btn:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
      }

      .notification.success {
        background-color: #28a745;
        border: 1px solid #1e7e34;
      }

      .notification.error {
        background-color: #dc3545;
        border: 1px solid #c82333;
      }

      .notification.info {
        background-color: #17a2b8;
        border: 1px solid #138496;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .lesson-modal-header h2,
      .lesson-viewer-header h2 {
        margin: 0;
        color: #333;
      }

      .close-lesson-modal,
      .close-lesson-viewer {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 5px;
        line-height: 1;
      }

      .close-lesson-modal:hover,
      .close-lesson-viewer:hover {
        color: #000;
      }

      .lesson-modal-body,
      .lesson-viewer-body {
        padding: 30px;
      }

      .lesson-type-selector {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .lesson-type-btn {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .lesson-type-btn:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .lesson-type-btn.remedial-btn:hover {
        border-color: #dc3545;
        background: #fdf2f2;
      }

      .lesson-type-btn.initial-btn:hover {
        border-color: #28a745;
        background: #f2f8f2;
      }

      .lesson-type-btn.all-btn:hover {
        border-color: #6c757d;
        background: #f8f9fa;
      }

      .lesson-type-btn i {
        font-size: 32px;
        color: #666;
      }

      .lesson-type-btn.remedial-btn i {
        color: #dc3545;
      }

      .lesson-type-btn.initial-btn i {
        color: #28a745;
      }

      .lesson-type-btn.all-btn i {
        color: #6c757d;
      }

      .lesson-type-info h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 18px;
      }

      .lesson-type-info p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .lesson-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .back-btn,
      .back-to-lessons-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s ease;
      }

      .back-btn:hover,
      .back-to-lessons-btn:hover {
        background: #5a6268;
      }

      .lesson-list-header h3 {
        margin: 0;
        color: #333;
        flex: 1;
      }

      .lesson-items {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .lesson-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .lesson-item:hover {
        border-color: #007bff;
        background: #f8f9ff;
        transform: translateX(5px);
      }

      .lesson-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .lesson-item-title {
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .lesson-item-type {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .lesson-item-type.remedial {
        background: #fed7d7;
        color: #c53030;
      }

      .lesson-item-type.initial {
        background: #c6f6d5;
        color: #2f855a;
      }

      .lesson-item-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 8px;
      }

      .lesson-tag {
        background: #e9ecef;
        color: #495057;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
      }

      .lesson-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 150px;
        height: 44px;
        justify-content: center;
        letter-spacing: 0.025em;
        box-sizing: border-box;
        flex-shrink: 0;
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        color: white;
      }

      .lesson-btn:hover {
        background: linear-gradient(135deg, #138496 0%, #1ea080 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
      }

      /* Lesson Content Styles */
      .lesson-video {
        margin-bottom: 20px;
      }

      .lesson-content-blocks {
        line-height: 1.6;
      }

      .content-header {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin: 20px 0 15px 0;
      }

      .content-paragraph {
        margin: 15px 0;
        color: #555;
      }

      .content-code {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        overflow-x: auto;
        margin: 15px 0;
        font-family: "Courier New", monospace;
      }

      .content-list {
        margin: 15px 0;
        padding-left: 20px;
      }

      .content-list li {
        margin: 5px 0;
        color: #555;
      }

      .content-summary {
        background: #e8f4f8;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }

      .content-summary h4 {
        margin: 0 0 10px 0;
        color: #17a2b8;
      }

      .content-summary p {
        margin: 0;
        color: #555;
      }

      .no-content,
      .error-message,
      .no-lessons {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* Initial Learning Layout Styles */
      .welcome-message {
        text-align: center;
        padding: 60px 40px;
        color: #666;
      }

      .welcome-message h2 {
        color: #2c3e50;
        margin-bottom: 20px;
      }

      .lesson-content,
      .video-content {
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
      }

      .lesson-content h2,
      .video-content h2 {
        color: #2c3e50;
        border-bottom: 2px solid #4a90e2;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      .lesson-body {
        font-size: 1.1em;
        color: #444;
      }

      .lesson-body h3,
      .lesson-body h4 {
        color: #2c3e50;
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.53em;
      }

      .lesson-body p {
        margin-bottom: 20px;
      }

      .lesson-body ul,
      .lesson-body ol {
        margin-bottom: 20px;
        padding-left: 30px;
      }

      .lesson-body li {
        margin-bottom: 8px;
      }

      .lesson-body pre {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #4a90e2;
        overflow-x: auto;
        margin: 20px 0;
      }

      .lesson-body code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
      }

      .no-content,
      .error {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
      }

      .error {
        color: #dc3545;
      }

      #initial-topics-nav a {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #initial-topics-nav a i {
        width: 16px;
        text-align: center;
      }

      .lesson-order-number {
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        flex-shrink: 0;
      }

      .progress-indicator {
        color: #28a745;
        font-size: 16px;
        margin-left: auto;
      }

      .progress-indicator.completed {
        color: #28a745;
      }

      .progress-indicator.incomplete {
        color: #ddd;
      }

      #initial-topics-nav a.completed {
        background: linear-gradient(135deg, #1f2937, #111827);
        border-left: 4px solid #34d399;
        color: #f3f4f6;
        box-shadow: 0 12px 24px rgba(15, 118, 110, 0.25);
      }

      #initial-topics-nav a.completed:hover {
        background: linear-gradient(135deg, #111827, #0f172a);
        border-color: #6ee7b7;
      }

      #initial-topics-nav a.completed .lesson-order-number {
        background-color: rgba(16, 185, 129, 0.2);
        color: #bbf7d0;
      }

      #initial-topics-nav a.completed .progress-indicator {
        color: #6ee7b7;
      }

      .quiz-section {
        margin-top: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 12px;
        color: white;
        text-align: center;
      }

      .quiz-section.disabled {
        background: linear-gradient(135deg, #6c757d, #495057);
        opacity: 0.7;
      }

      .quiz-section h3 {
        margin-top: 0;
        margin-bottom: 10px;
      }

      .quiz-section p {
        margin-bottom: 20px;
        opacity: 0.9;
      }

      .quiz-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .quiz-button {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .quiz-button:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .quiz-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }

      .completion-trigger {
        height: 1px;
        width: 100%;
        margin-top: 20px;
        position: relative;
      }

      .completion-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideInUp 0.5s ease, pulse 2s infinite;
        z-index: 1000;
      }

      @keyframes slideInUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
    </style>

    <script>
      // Global variables
      let currentSubject = "";
      let currentSubtopic = "";
      let currentLesson = null;
  const initialTokenBalance = {{ token_balance if token_balance is not none else 0 }};
  let currentTokenBalance = initialTokenBalance;

      const lessonCompletionCache = new Map();
      const videoCompletionCache = new Map();

      const MARKDOWN_OPTIONS = {
        mangle: false,
        headerIds: false,
        breaks: true,
      };

      function escapeHtml(value) {
        return String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function hasMarkdownSupport() {
        return (
          typeof window !== "undefined" &&
          typeof window.DOMPurify !== "undefined" &&
          typeof window.marked !== "undefined"
        );
      }

      function renderInlineMarkdown(text) {
        const rawText = String(text ?? "");
        if (!rawText) {
          return "";
        }

        if (!hasMarkdownSupport()) {
          return escapeHtml(rawText);
        }

        const rendered = window.marked.parseInline(rawText, MARKDOWN_OPTIONS);
        return window.DOMPurify.sanitize(rendered);
      }

      function renderBlockMarkdown(text) {
        const rawText = String(text ?? "");
        if (!rawText) {
          return "";
        }

        if (!hasMarkdownSupport()) {
          // Convert newlines to <br> tags for fallback rendering
          const escaped = escapeHtml(rawText).replace(/\n/g, '<br>');
          return `<p>${escaped}</p>`;
        }

        // Convert single newlines to double newlines for proper Markdown paragraph breaks
        const markdownText = rawText.replace(/\n/g, '  \n');
        const rendered = window.marked.parse(markdownText, MARKDOWN_OPTIONS);
        return window.DOMPurify.sanitize(rendered);
      }

      async function handleSubtopicAccess(subject, subtopic) {
        try {
          const response = await fetch(
            `/api/subtopic-prerequisites/${subject}/${subtopic}`
          );

          if (!response.ok) {
            showInitialLessons(subject, subtopic);
            return;
          }

          const data = await response.json();

          // Check if subtopic is inactive
          if (data.subtopic_inactive || data.is_active === false) {
            alert(
              "This topic is currently unavailable.\n\nPlease check back later or contact your instructor for more information."
            );
            return;
          }

          if (
            data.admin_override ||
            !data.has_prerequisites ||
            data.can_access_subtopic
          ) {
            showInitialLessons(subject, subtopic);
            return;
          }

          const missing = Array.isArray(data.missing_prerequisites)
            ? data.missing_prerequisites
            : [];
          const message =
            missing.length > 0
              ? `Complete these prerequisite subtopics first:\n\n• ${missing.join(
                  "\n• "
                )}`
              : "Complete the required prerequisites before starting this topic.";

          alert(message);

          if (typeof data.redirect_url === "string") {
            window.location.href = data.redirect_url;
          } else {
            window.location.href = `/subjects/${subject}/${subtopic}/prerequisites`;
          }
        } catch (error) {
          console.error("Error checking subtopic prerequisites:", error);
          showInitialLessons(subject, subtopic);
        }
      }

      function showInitialLessons(subject, subtopic) {
        currentSubject = subject;
        currentSubtopic = subtopic;

        // Hide the topics grid and show the blackboard layout
        document.querySelector(".topics-grid").style.display = "none";
        document.getElementById("initial-learning-layout").style.display =
          "flex";

        // Update sidebar title
        document.getElementById("initial-learning-title").textContent = `${
          subtopic.charAt(0).toUpperCase() + subtopic.slice(1)
        } Learning`;
        const videoCount = getSubtopicVideoCount(subtopic);
        document.getElementById("initial-learning-subtitle").textContent =
          typeof videoCount === "number" && videoCount <= 0
            ? "Learn with lessons for this topic."
            : "Learn with lessons and videos for this topic.";

        initializeLessonQuizButton(subject, subtopic);
        updateQuizButtonStatus(subject, subtopic);

        // Load lessons and videos into sidebar
        loadInitialContent(subject, subtopic, videoCount);
      }

      // New function to load content into the sidebar layout
      function loadInitialContent(subject, subtopic, videoCount) {
        const navList = document.getElementById("initial-topics-nav");
        navList.innerHTML =
          '<li><div class="loading">Loading content...</div></li>';

        // Load lessons and videos
        // VIDEO FEATURE DISABLED (temporary). Keeping original implementation
        // commented out below so it can be restored later.
        // const shouldFetchVideos = !(
        //   typeof videoCount === "number" && videoCount <= 0
        // );
        Promise.all([
          fetch(`/api/lesson-plans/${subject}/${subtopic}`)
            .then((r) => r.json())
            .catch(() => ({ lessons: {} })),
          // shouldFetchVideos
          //   ? fetch(`/api/video/${subject}/${subtopic}/all`)
          //       .then((r) => r.json())
          //       .catch(() => ({ videos: {} }))
          //   : Promise.resolve({ videos: [] }),
          Promise.resolve({ videos: [] }),
        ])
          .then(([lessonData, videoData]) => {
            navList.innerHTML = "";

            // Add lessons to sidebar
            if (
              lessonData.lessons &&
              Object.keys(lessonData.lessons).length > 0
            ) {
              // Convert to array and sort by order for guaranteed ordering
              const lessonEntries = Object.entries(lessonData.lessons);
              const initialLessons = lessonEntries
                .filter(([lessonId, lesson]) => {
                  const lessonTypeValue = lesson.type || "initial";
                  return (
                    lessonTypeValue === "initial" || lessonTypeValue === "all"
                  );
                })
                .sort(([, a], [, b]) => {
                  const orderA = a.order || 999;
                  const orderB = b.order || 999;
                  return orderA - orderB;
                });

              initialLessons.forEach(([lessonId, lesson]) => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = "#";
                const resolvedLessonId = resolveLessonId(lesson, lessonId);
                a.dataset.lessonId = resolvedLessonId;
                a.dataset.lessonKey = lessonId;
                if (lesson.completed) {
                  a.classList.add("completed");
                }

                // Add order number for initial lessons
                const orderPrefix = lesson.order
                  ? `<span class="lesson-order-number">${lesson.order}</span>`
                  : "";

                a.innerHTML = `${orderPrefix}<i class="fas fa-book"></i> ${lesson.title}`;
                a.onclick = (e) => {
                  e.preventDefault();
                  document
                    .querySelectorAll("#initial-topics-nav a")
                    .forEach((link) => link.classList.remove("active"));
                  e.target.closest("a").classList.add("active");
                  displayInitialLesson(
                    lesson,
                    resolvedLessonId,
                    subject,
                    subtopic
                  );
                };
                li.appendChild(a);
                navList.appendChild(li);
              });
            }

            /*
            // Add videos to sidebar
            const videosCollection = Array.isArray(videoData.videos)
              ? videoData.videos
              : Object.entries(videoData.videos || {}).map(
                  ([videoId, video]) => ({ id: videoId, ...(video || {}) })
                );

            if (videosCollection.length > 0) {
              videosCollection.forEach((video, index) => {
                const videoId =
                  video.id ||
                  video.video_id ||
                  video.topic_key ||
                  `video-${index + 1}`;
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = "#";
                a.dataset.videoId = videoId;

                a.innerHTML = `<i class="fas fa-play"></i> ${
                  video.title || videoId
                }`;
                a.onclick = (e) => {
                  e.preventDefault();
                  document
                    .querySelectorAll("#initial-topics-nav a")
                    .forEach((link) => link.classList.remove("active"));
                  e.target.closest("a").classList.add("active");
                  displayInitialVideo(video, videoId, subject, subtopic);
                };
                li.appendChild(a);
                navList.appendChild(li);
              });
            }
            */

            if (navList.children.length === 0) {
              navList.innerHTML =
                '<li><div class="no-content">No lessons or videos available for this topic.</div></li>';
            }
          })
          .catch((error) => {
            console.error("Error loading initial content:", error);
            navList.innerHTML =
              '<li><div class="error">Error loading content. Please try again.</div></li>';
          });
      }

      function getSubtopicVideoCount(subtopic) {
        if (!subtopic) return null;
        const card =
          document.getElementById(`${subtopic}-card`) ||
          document.querySelector(`.topic-card[data-subtopic="${subtopic}"]`);
        if (!card) return null;
        const rawValue = card.dataset.videoCount;
        if (rawValue === undefined || rawValue === null) return null;
        const parsed = Number.parseInt(rawValue, 10);
        return Number.isFinite(parsed) ? parsed : null;
      }

      // Function to display lesson content
      function displayInitialLesson(lesson, lessonId, subject, subtopic) {
        const contentDisplay = document.getElementById(
          "initial-content-display"
        );

        // Remove active class from all nav items and add to current
        document
          .querySelectorAll("#initial-topics-nav a")
          .forEach((a) => a.classList.remove("active"));

        // Parse lesson content if it's an array of content objects
        let lessonHTML = "";
        if (Array.isArray(lesson.content)) {
          lessonHTML = formatLessonContent(lesson.content);
        } else if (typeof lesson.content === "string") {
          lessonHTML = lesson.content;
        } else {
          lessonHTML = "<p>Lesson content not available.</p>";
        }

        contentDisplay.innerHTML = `
          <div class="lesson-content" id="lesson-content-${lessonId}">
            <h2>${lesson.title}</h2>
            <div class="lesson-body">
              ${lessonHTML}
            </div>
          </div>
        `;

        const resolvedLessonId = resolveLessonId(lesson, lessonId);
        const activeNavLink = Array.from(
          document.querySelectorAll("#initial-topics-nav a")
        ).find((link) => link.dataset.lessonId === resolvedLessonId);

        if (activeNavLink) {
          activeNavLink.classList.add("active");
        }
        markLessonNavAsCompleted(resolvedLessonId);
        if (!lesson.completed) {
          persistLessonCompletion({
            subject,
            subtopic,
            lessonId: resolvedLessonId,
            silent: true,
          });
        }
      }

      // Function to format structured lesson content
      function formatLessonContent(contentArray) {
        return contentArray
          .map((item) => {
            switch (item.type) {
              case "header":
                return `<h3>${processInlineCode(item.text)}</h3>`;
              case "paragraph":
                return `<p>${processInlineCode(item.text)}</p>`;
              case "code":
                return `<pre><code>${item.text}</code></pre>`;
              case "list":
                const listItems = item.items
                  .map((listItem) => `<li>${processInlineCode(listItem)}</li>`)
                  .join("");
                return `<ul>${listItems}</ul>`;
              case "code_runner":
                const blockId = Math.random().toString(36).substr(2, 9);
                return `
                  <div class="code-runner-block" id="code-runner-${blockId}">
                    <div class="code-runner-header">
                      <h4><i class="fas fa-play-circle"></i> Interactive Python Code</h4>
                      <button class="code-runner-toggle" type="button" onclick="expandCodeRunner('${blockId}')" aria-expanded="false" aria-label="Expand code runner">
                        <i class="fas fa-expand-alt"></i>
                      </button>
                    </div>
                    <div class="code-runner-content">
                      <div class="code-editor">
                        <textarea id="code-editor-${blockId}" class="python-editor" placeholder="Write your Python code here...">${
                  item.starter_code ||
                  '# Write your Python code here\nprint("Hello, World!")'
                }</textarea>
                      </div>
                      <div class="code-controls">
                        <button class="run-code-btn" onclick="runPythonCode('${blockId}')">
                          <i class="fas fa-play"></i> Run Code
                        </button>
                        <button class="clear-output-btn" onclick="clearOutput('${blockId}')">
                          <i class="fas fa-trash"></i> Clear Output
                        </button>
                        ${
                          item.allow_ai_analysis !== false
                            ? `<button class="ai-analysis-btn" onclick="openAiAnalysisModal('${blockId}')"><i class="fas fa-robot"></i> AI Analysis</button>`
                            : ""
                        }
                        ${
                          item.solution
                            ? `<button class="show-solution-btn" onclick="showSolution('${blockId}')"><i class="fas fa-lightbulb"></i> Show Solution</button>`
                            : ""
                        }
                        ${
                          item.hints && item.hints.length > 0
                            ? `<button class="show-hints-btn" onclick="showHints('${blockId}')"><i class="fas fa-question-circle"></i> Show Hints</button>`
                            : ""
                        }
                      </div>
                      <div class="code-output">
                        <div class="output-header">Output:</div>
                        <pre id="code-output-${blockId}" class="output-content"></pre>
                      </div>
                      ${
                        item.expected_output
                          ? `<div class="expected-output"><strong>Expected Output:</strong><pre>${item.expected_output}</pre></div>`
                          : ""
                      }
                      ${
                        item.hints && item.hints.length > 0
                          ? `<div class="hints-content" id="hints-${blockId}" style="display: none;"><strong>Hints:</strong><ul>${item.hints
                              .map((hint) => `<li>${hint}</li>`)
                              .join("")}</ul></div>`
                          : ""
                      }
                      ${
                        item.solution
                          ? `<div class="solution-content" id="solution-${blockId}" style="display: none;"><strong>Solution:</strong><pre><code>${item.solution}</code></pre></div>`
                          : ""
                      }
                    </div>
                  </div>
                `;
              default:
                return `<p>${processInlineCode(
                  item.text || JSON.stringify(item)
                )}</p>`;
            }
          })
          .join("");
      }

      // Helper function to process inline code marks (backticks)
      function processInlineCode(text) {
        if (!text) return text;
        // Replace `code` with <code>code</code>
        return text.replace(/`([^`]+)`/g, "<code>$1</code>");
      }

      // Function to display video content
      function displayInitialVideo(video, videoId, subject, subtopic) {
        const contentDisplay = document.getElementById(
          "initial-content-display"
        );

        // Remove active class from all nav items
        document
          .querySelectorAll("#initial-topics-nav a")
          .forEach((a) => a.classList.remove("active"));

        const embedUrl = video.url
          ? video.url.replace("watch?v=", "embed/")
          : "";

        contentDisplay.innerHTML = `
          <div class="video-content" id="video-content-${videoId}">
            <h2>${video.title || videoId}</h2>
            <div class="video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
              <iframe 
                id="lesson-video-iframe"
                src="${embedUrl}?enablejsapi=1" 
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                frameborder="0" 
                allowfullscreen>
              </iframe>
            </div>
            <div class="video-description" style="margin-top: 20px;">
              ${
                video.description ||
                "<p>Watch this video to learn about the topic.</p>"
              }
            </div>
          </div>
        `;

        markVideoNavAsCompleted(videoId);
        persistVideoCompletion({ subject, subtopic, videoId });
      }

      // Function to go back to topics grid
      function backToTopicsFromInitial() {
        const initialLayout = document.getElementById("initial-learning-layout");
        if (initialLayout) {
          initialLayout.style.display = "none";
        }

        const topicsGrid = document.querySelector(".topics-grid");
        if (topicsGrid) {
          topicsGrid.style.display = "";
        }
      }

      function showLessonSelector(subject, subtopic) {
        currentSubject = subject;
        currentSubtopic = subtopic;
        document.getElementById(
          "lesson-modal-title"
        ).textContent = `Select Lesson Type - ${
          subtopic.charAt(0).toUpperCase() + subtopic.slice(1)
        }`;
        document.getElementById("lesson-modal").style.display = "flex";
        document.getElementById("lesson-list").style.display = "none";
        document.querySelector(".lesson-type-selector").style.display = "flex";
      }

      function closeLessonModal() {
        document.getElementById("lesson-modal").style.display = "none";
      }

      function showLessons(lessonType) {
        currentLessonType = lessonType;
        document.querySelector(".lesson-type-selector").style.display = "none";
        document.getElementById("lesson-list").style.display = "block";

        let typeTitle =
          lessonType === "remedial"
            ? "Remedial Lessons"
            : lessonType === "initial"
            ? "Initial Lessons"
            : "All Lessons";
        document.getElementById("lesson-list-title").textContent = typeTitle;

        loadLessons(currentSubject, currentSubtopic, lessonType);
      }

      function loadLessons(subject, subtopic, lessonType) {
        const lessonItems = document.getElementById("lesson-items");
        lessonItems.innerHTML = '<div class="loading">Loading lessons...</div>';

        // Load lessons directly from the subtopic's lesson_plans.json
        fetch(`/api/lesson-plans/${subject}/${subtopic}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.lessons && Object.keys(data.lessons).length > 0) {
              // Filter lessons by type if specified
              const filteredLessons = [];
              Object.entries(data.lessons).forEach(([lessonId, lesson]) => {
                const lessonTypeValue = lesson.type || "remedial"; // Default to remedial if no type specified
                const resolvedLessonId =
                  lesson.id || lesson.lesson_id || lessonId;

                if (lessonType === "all" || lessonTypeValue === lessonType) {
                  filteredLessons.push({
                    id: resolvedLessonId,
                    lesson_id: resolvedLessonId,
                    title: lesson.title,
                    type: lessonTypeValue,
                    tags: lesson.tags || [],
                    order: lesson.order !== undefined ? lesson.order : 999,
                    subtopic: subtopic,
                    subject: subject,
                    content: lesson.content,
                    videoId: lesson.videoId,
                    completed: lesson.completed || false, // Include completion status
                  });
                }
              });

              // Sort lessons by order field (lower numbers first)
              filteredLessons.sort((a, b) => {
                if (a.order !== b.order) {
                  return a.order - b.order;
                }
                // If orders are equal, sort by title as secondary
                return (a.title || "").localeCompare(b.title || "");
              });

              if (filteredLessons.length > 0) {
                displayLessons(filteredLessons);
              } else {
                lessonItems.innerHTML = `
                  <div class="no-lessons">
                    <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                    <h3>No ${
                      lessonType === "all" ? "" : lessonType
                    } lessons found</h3>
                    <p>No ${
                      lessonType === "all" ? "" : lessonType + " "
                    }lessons are available for this topic yet.</p>
                  </div>
                `;
              }
            } else {
              lessonItems.innerHTML = `
                <div class="no-lessons">
                  <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                  <h3>No lessons found</h3>
                  <p>No lessons are available for this topic yet.</p>
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Error loading lessons:", error);
            lessonItems.innerHTML = `
              <div class="error-message">
                <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-bottom: 10px;"></i>
                <p>Error loading lessons. Please try again.</p>
              </div>
            `;
          });
      }

      function displayLessons(lessons) {
        const lessonItems = document.getElementById("lesson-items");
        lessonItems.innerHTML = "";

        lessons.forEach((lesson) => {
          const lessonElement = document.createElement("div");
          lessonElement.className = "lesson-item";
          lessonElement.dataset.lessonId = lesson.lesson_id || lesson.id || "";

          // Check if lesson is completed
          const isCompleted = lesson.completed || false;
          if (isCompleted) {
            lessonElement.classList.add("lesson-completed");
          }

          lessonElement.onclick = () => openLesson(lesson);

          const tags = lesson.tags
            ? lesson.tags
                .map((tag) => `<span class="lesson-tag">${tag}</span>`)
                .join("")
            : "";
          const lessonType = lesson.type || "remedial";
          const completionIcon = isCompleted
            ? '<i class="fas fa-check-circle lesson-completion-icon"></i>'
            : "";

          lessonElement.innerHTML = `
            <div class="lesson-item-header">
              <h4 class="lesson-item-title">${
                lesson.title
              } ${completionIcon}</h4>
              <span class="lesson-item-type ${lessonType}">${
            lessonType.charAt(0).toUpperCase() + lessonType.slice(1)
          }</span>
            </div>
            <div class="lesson-item-tags">${tags}</div>
          `;

          lessonItems.appendChild(lessonElement);
        });
      }

      function openLesson(lesson) {
        document.getElementById("lesson-modal").style.display = "none";
        document.getElementById("lesson-viewer-title").textContent =
          lesson.title;
        document.getElementById("lesson-viewer-modal").style.display = "flex";

        // Store current lesson for tracking
        currentLesson = lesson;

        const openedLessonId = resolveLessonId(lesson);
        updateOpenedLessonHighlight(openedLessonId);

        const lessonQuizButtons = getLessonQuizButtons().filter(
          (button) =>
            button.dataset.subject === currentSubject &&
            button.dataset.subtopic === currentSubtopic
        );

        lessonQuizButtons.forEach((button) => {
          const hasQuiz = button.dataset.hasQuiz === "true";
          const isUnlocked = !button.classList.contains("locked");
          button.style.display = hasQuiz && isUnlocked ? "inline-flex" : "none";
        });

        const lessonQuizBtn = document.getElementById("lesson-quiz-btn");
        if (lessonQuizBtn) {
          const hasQuiz = lessonQuizBtn.dataset.hasQuiz === "true";
          const isUnlocked = !lessonQuizBtn.classList.contains("locked");
          lessonQuizBtn.style.display =
            hasQuiz && isUnlocked ? "inline-flex" : "none";
          lessonQuizBtn.onclick = () =>
            handleQuizAccess(currentSubject, currentSubtopic);
        }

        renderLessonContent(lesson);
        checkLessonCompletion(lesson);

        if (openedLessonId && !lesson.completed) {
          persistLessonCompletion({
            subject: currentSubject,
            subtopic: currentSubtopic,
            lessonId: openedLessonId,
            silent: true,
          });
        } else if (openedLessonId) {
          markLessonNavAsCompleted(openedLessonId);
          markLessonListAsCompleted(openedLessonId);
        }
      }

      function loadLessonContent(lesson) {
        // This function is no longer needed since we pass the full lesson object
        renderLessonContent(lesson);
      }

      function renderLessonContent(lesson) {
        const lessonBody = document.getElementById("lesson-viewer-body");
        let contentHtml = "";

        // Add video if available
        if (lesson.videoId) {
          const safeVideoId = escapeHtml(lesson.videoId);
          contentHtml += `
            <div class="lesson-video">
              <iframe width="100%" height="400"
                      src="https://www.youtube.com/embed/${safeVideoId}"
                      frameborder="0" allowfullscreen>
              </iframe>
            </div>
          `;
        }

        // Add lesson content
        if (lesson.content && lesson.content.length > 0) {
          contentHtml += '<div class="lesson-content-blocks">';

          lesson.content.forEach((block) => {
            switch (block.type) {
              case "header":
                {
                  const headerHtml = renderInlineMarkdown(block.text || "");
                  if (headerHtml) {
                    contentHtml += `<h3 class="content-header">${headerHtml}</h3>`;
                  }
                }
                break;
              case "paragraph":
                {
                  const paragraphHtml = renderBlockMarkdown(block.text || "");
                  if (paragraphHtml) {
                    contentHtml += `<div class="content-paragraph">${paragraphHtml}</div>`;
                  }
                }
                break;
              case "code":
                contentHtml += `<pre class="content-code"><code>${escapeHtml(
                  block.text || ""
                )}</code></pre>`;
                break;
              case "list":
                {
                  const listItems = (block.items || [])
                    .map((item) => {
                      const itemHtml = renderInlineMarkdown(item || "");
                      return itemHtml ? `<li>${itemHtml}</li>` : "";
                    })
                    .join("");
                  if (listItems) {
                    contentHtml += `<ul class="content-list">${listItems}</ul>`;
                  }
                }
                break;
              case "summary":
                {
                  const summaryHtml = renderBlockMarkdown(block.text || "");
                  if (summaryHtml) {
                    contentHtml += `<div class="content-summary"><h4>Summary</h4>${summaryHtml}</div>`;
                  }
                }
                break;
              default: {
                const blockHtml = renderBlockMarkdown(block.text || "");
                if (blockHtml) {
                  contentHtml += `<div class="content-block">${blockHtml}</div>`;
                }
              }
            }
          });

          contentHtml += "</div>";

          // Add completion section at the bottom
          contentHtml += `
            <div class="lesson-completion-section">
              <div class="lesson-completion-trigger" id="lesson-completion-trigger"></div>
              <div class="lesson-completion-actions">
                <button id="mark-complete-btn" class="mark-complete-btn" onclick="markLessonComplete()" style="display: none;">
                  <i class="fas fa-check"></i> Mark as Complete
                </button>
                <div id="lesson-completed-indicator" class="lesson-completed-indicator-bottom" style="display: none;">
                  <i class="fas fa-check-circle"></i> 
                  <span>Lesson Completed!</span>
                </div>
              </div>
            </div>
          `;
        } else {
          contentHtml +=
            '<div class="no-content">No content available for this lesson.</div>';
        }

        lessonBody.innerHTML = contentHtml;

        // Set up scroll-based completion tracking if lesson is not already completed
        if (!lesson.completed) {
          setupScrollTracking();
        }
      }

      function setupScrollTracking() {
        const lessonBody = document.getElementById("lesson-viewer-body");
        const completionTrigger = document.getElementById(
          "lesson-completion-trigger"
        );

        if (!completionTrigger) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (
                entry.isIntersecting &&
                currentLesson &&
                !currentLesson.completed
              ) {
                // User has scrolled to the bottom, suggest completion
                showCompletionSuggestion();
                observer.disconnect(); // Stop observing once triggered
              }
            });
          },
          { threshold: 1.0 }
        );

        observer.observe(completionTrigger);
      }

      function showCompletionSuggestion() {
        const markCompleteBtn = document.getElementById("mark-complete-btn");
        if (markCompleteBtn && markCompleteBtn.style.display !== "none") {
          // Highlight the button to draw attention
          markCompleteBtn.style.animation = "pulse 1s ease-in-out 3";
          markCompleteBtn.style.boxShadow = "0 0 15px rgba(40, 167, 69, 0.5)";

          // Show a tooltip-like message
          showNotification(
            "You've reached the end! Mark this lesson as complete.",
            "info"
          );
        }
      }

      function backToLessonList() {
        document.getElementById("lesson-viewer-modal").style.display = "none";
        document.getElementById("lesson-modal").style.display = "flex";
      }

      function closeLessonViewer() {
        document.getElementById("lesson-viewer-modal").style.display = "none";
        const lessonQuizBtn = document.getElementById("lesson-quiz-btn");
        if (lessonQuizBtn) {
          lessonQuizBtn.style.display = "none";
        }
        const lessonRequirements = document.getElementById(
          "lesson-quiz-requirements"
        );
        if (lessonRequirements) {
          lessonRequirements.style.display = "none";
        }
      }

      function checkLessonCompletion(lesson) {
        // Check if current lesson is completed
        const isCompleted = lesson.completed || false;
        const markCompleteBtn = document.getElementById("mark-complete-btn");
        const completedIndicator = document.getElementById(
          "lesson-completed-indicator"
        );
        const completedIndicatorHeader = document.getElementById(
          "lesson-completed-indicator-header"
        );

        if (isCompleted) {
          if (markCompleteBtn) markCompleteBtn.style.display = "none";
          if (completedIndicator) completedIndicator.style.display = "flex";
          if (completedIndicatorHeader)
            completedIndicatorHeader.style.display = "flex";
        } else {
          if (markCompleteBtn) markCompleteBtn.style.display = "flex";
          if (completedIndicator) completedIndicator.style.display = "none";
          if (completedIndicatorHeader)
            completedIndicatorHeader.style.display = "none";
        }
      }

      function resolveLessonId(lesson, fallbackId) {
        if (!lesson) return fallbackId || "";
        return lesson.id || lesson.lesson_id || fallbackId || "";
      }

      function markLessonNavAsCompleted(lessonId) {
        if (!lessonId) return;
        document.querySelectorAll("#initial-topics-nav a").forEach((link) => {
          if (link.dataset.lessonId === lessonId) {
            link.classList.add("completed");
          }
        });
      }

      function markVideoNavAsCompleted(videoId) {
        if (!videoId) return;
        document.querySelectorAll("#initial-topics-nav a").forEach((link) => {
          if (link.dataset.videoId === videoId) {
            link.classList.add("completed");
          }
        });
      }

      function getLessonQuizButtons() {
        return Array.from(document.querySelectorAll(".lesson-quiz-btn"));
      }

      function updateOpenedLessonHighlight(lessonId) {
        const lessonItems = document.querySelectorAll(".lesson-item");
        lessonItems.forEach((item) => {
          if (!item.classList.contains("lesson-completed")) {
            item.classList.remove("lesson-opened");
          }
        });

        if (!lessonId) return;

        document
          .querySelectorAll(`.lesson-item[data-lesson-id=\"${lessonId}\"]`)
          .forEach((item) => {
            if (!item.classList.contains("lesson-completed")) {
              item.classList.add("lesson-opened");
            }
          });
      }

      function markLessonListAsCompleted(lessonId) {
        if (!lessonId) return;
        document
          .querySelectorAll(`.lesson-item[data-lesson-id=\"${lessonId}\"]`)
          .forEach((item) => {
            item.classList.add("lesson-completed");
            item.classList.remove("lesson-opened");
            const titleEl = item.querySelector(".lesson-item-title");
            if (titleEl && !titleEl.querySelector(".lesson-completion-icon")) {
              const icon = document.createElement("i");
              icon.className = "fas fa-check-circle lesson-completion-icon";
              titleEl.appendChild(icon);
            }
          });
      }

      function applyLessonCompletionEffects(lessonId) {
        if (!lessonId) return;

        if (currentLesson && resolveLessonId(currentLesson) === lessonId) {
          currentLesson.completed = true;
          checkLessonCompletion(currentLesson);
        }

        markLessonNavAsCompleted(lessonId);
        markLessonListAsCompleted(lessonId);
        updateSubtopicProgressAfterCompletion();
        updateQuizButtonStatus(currentSubject, currentSubtopic);
      }

      async function persistLearningItemOpen({
        subject,
        subtopic,
        itemId,
        itemType,
        silent = true,
        successMessage,
        failureMessage,
        onSuccess,
      }) {
        if (!subject || !subtopic || !itemId || !itemType) return false;

        const cacheMap =
          itemType === "video" ? videoCompletionCache : lessonCompletionCache;
        const cacheKey = `${itemType}::${subject}::${subtopic}::${itemId}`;
        const cachedValue = cacheMap.get(cacheKey);

        if (cachedValue === true) {
          return true;
        }

        if (
          cachedValue &&
          typeof cachedValue === "object" &&
          typeof cachedValue.then === "function"
        ) {
          return cachedValue;
        }

        const request = (async () => {
          try {
            const response = await fetch("/api/progress/update", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                subject,
                subtopic,
                item_id: itemId,
                item_type: itemType,
              }),
            });

            const result = await response.json().catch(() => ({}));

            if (response.ok && result.success) {
              if (typeof onSuccess === "function") {
                onSuccess();
              }
              if (!silent && successMessage) {
                showNotification(successMessage, "success");
              }
              cacheMap.set(cacheKey, true);
              return true;
            }

            if (!silent && failureMessage) {
              showNotification(result.error || failureMessage, "error");
            }
            return false;
          } catch (error) {
            console.error("Error updating progress:", error);
            if (!silent && failureMessage) {
              showNotification(failureMessage, "error");
            }
            return false;
          } finally {
            if (cacheMap.get(cacheKey) === request) {
              cacheMap.delete(cacheKey);
            }
          }
        })();

        cacheMap.set(cacheKey, request);
        return request;
      }

      async function persistLessonCompletion({
        subject,
        subtopic,
        lessonId,
        silent = true,
      }) {
        return persistLearningItemOpen({
          subject,
          subtopic,
          itemId: lessonId,
          itemType: "lesson",
          silent,
          successMessage: "Lesson marked as complete!",
          failureMessage: "Failed to mark lesson as complete",
          onSuccess: () => applyLessonCompletionEffects(lessonId),
        });
      }

      async function persistVideoCompletion({
        subject,
        subtopic,
        videoId,
        silent = true,
      }) {
        return persistLearningItemOpen({
          subject,
          subtopic,
          itemId: videoId,
          itemType: "video",
          silent,
          failureMessage: "Failed to record video progress",
          onSuccess: () => {
            markVideoNavAsCompleted(videoId);
            updateQuizButtonStatus();
            updateSubtopicProgressAfterCompletion();
          },
        });
      }

      function initializeLessonQuizButton(subject, subtopic) {
        const quizButtons = getLessonQuizButtons();
        if (!quizButtons.length) return;

        const card = document.getElementById(`${subtopic}-card`);
        const hasQuiz = card && card.dataset.hasQuiz === "true";

        quizButtons.forEach((button) => {
          button.dataset.subject = subject;
          button.dataset.subtopic = subtopic;
          button.dataset.hasQuiz = hasQuiz ? "true" : "false";
        });

        if (!hasQuiz) {
          quizButtons.forEach((button) => {
            button.style.display = "none";
            button.disabled = true;
            button.removeAttribute("title");
          });
          return;
        }

        quizButtons.forEach((button) => {
          button.style.display = "none";
          setLessonQuizButtonState(
            button,
            "locked",
            "Open all lessons and videos to unlock the quiz"
          );
          button.onclick = () => handleQuizAccess(subject, subtopic);
        });

        updateQuizButtonStatus();
      }

      function setLessonQuizButtonState(button, state, tooltip) {
        if (!button) return;

        button.classList.remove("locked", "ready", "admin");
        if (state) {
          button.classList.add(state);
        }

        const forceLockedVisible = button.dataset.showLocked === "true";
        let showButton = false;

        if (state === "admin" || state === "ready") {
          button.disabled = false;
          showButton = true;
        } else if (state === "locked") {
          button.disabled = true;
          showButton = forceLockedVisible;
        } else {
          button.disabled = true;
          showButton = forceLockedVisible;
        }

        button.style.display = showButton ? "inline-flex" : "none";

        if (tooltip) {
          button.title = tooltip;
        } else {
          button.removeAttribute("title");
        }
      }

      function applyLessonQuizButtonState(data) {
        const quizButtons = getLessonQuizButtons().filter(
          (button) =>
            button.dataset.hasQuiz === "true" &&
            button.dataset.subject === data.subject &&
            button.dataset.subtopic === data.subtopic
        );

        if (!quizButtons.length) {
          return;
        }

        if (data.admin_override) {
          quizButtons.forEach((button) =>
            setLessonQuizButtonState(
              button,
              "admin",
              "Admin override active - quiz unlocked"
            )
          );
          return;
        }

        if (!data.has_prerequisites) {
          quizButtons.forEach((button) =>
            setLessonQuizButtonState(
              button,
              "ready",
              "Quiz ready - no prerequisites required"
            )
          );
          return;
        }

        if (data.all_met) {
          quizButtons.forEach((button) =>
            setLessonQuizButtonState(
              button,
              "ready",
              "All lessons and videos opened. Take the quiz!"
            )
          );
        } else {
          const requirements = [];
          if (!data.lessons_complete) {
            requirements.push("open all lessons");
          }
          if (!data.videos_complete) {
            requirements.push("open all videos");
          }
          const tooltip = requirements.length
            ? `Finish ${requirements.join(" & ")} to unlock the quiz`
            : "Review the lesson content to unlock the quiz";
          quizButtons.forEach((button) =>
            setLessonQuizButtonState(button, "locked", tooltip)
          );
        }
      }

      async function markLessonComplete() {
        if (!currentLesson) return;
        const lessonId = resolveLessonId(currentLesson);

        await persistLessonCompletion({
          subject: currentSubject,
          subtopic: currentSubtopic,
          lessonId,
          silent: false,
        });
      }

      async function updateSubtopicProgressAfterCompletion() {
        try {
          const response = await fetch(
            `/api/progress/check/${currentSubject}/${currentSubtopic}`
          );
          if (response.ok) {
            const stats = await response.json();
            updateSubtopicProgress(currentSubtopic, stats);
          }
        } catch (error) {
          console.error("Error updating subtopic progress:", error);
        }
      }

      // Close modals when clicking outside
      document.addEventListener("click", function (e) {
        if (e.target.id === "lesson-modal") {
          closeLessonModal();
        }
        if (e.target.id === "lesson-viewer-modal") {
          closeLessonViewer();
        }
      });

      // Load lesson progress for all subtopics on page load
      async function loadLessonProgress() {
        const subject = "{{ subject }}";

        // Get all subtopic elements
        const subtopicCards = document.querySelectorAll("[data-subtopic]");

        for (const card of subtopicCards) {
          const subtopic = card.getAttribute("data-subtopic");

          try {
            const response = await fetch(
              `/api/progress/check/${subject}/${subtopic}`
            );
            if (response.ok) {
              const stats = await response.json();
              updateSubtopicProgress(subtopic, stats);
            }
          } catch (error) {
            console.error(`Error loading progress for ${subtopic}:`, error);
          }
        }
      }

      function updateSubtopicProgress(subtopic, stats) {
        if (typeof updateProgressBar === "function") {
          updateProgressBar(subtopic, stats);
        }
      }

      function updateLessonProgressDisplay(progressData) {
        // This function is kept for compatibility but we now use the stats API
        // for more accurate and efficient progress tracking
      }

      // Load progress when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadLessonProgress();

        const params = new URLSearchParams(window.location.search);
        const focusSubtopicRaw = params.get("focus");
        if (focusSubtopicRaw) {
          const focusSubtopic = focusSubtopicRaw.trim();
          if (focusSubtopic) {
            const subject = "{{ subject }}";
            const lessonButton = Array.from(
              document.querySelectorAll(".lesson-btn[data-subtopic]")
            ).find((btn) => btn.dataset.subtopic === focusSubtopic);

            if (lessonButton) {
              handleSubtopicAccess(subject, focusSubtopic);
              if (typeof lessonButton.focus === "function") {
                lessonButton.focus();
              }

              params.delete("focus");
              const newQuery = params.toString();
              const newUrl =
                window.location.pathname +
                (newQuery ? `?${newQuery}` : "") +
                window.location.hash;
              if (window.history && window.history.replaceState) {
                window.history.replaceState({}, "", newUrl);
              }
            }
          }
        }

        // Add event listener for back to topics button
        document
          .getElementById("backToTopicsFromInitial")
          .addEventListener("click", backToTopicsFromInitial);
      });

      // Notification system
      function showNotification(message, type = "info") {
        // Remove existing notifications
        document.querySelectorAll(".notification").forEach((n) => n.remove());

        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          animation: slideIn 0.3s ease-out;
          max-width: 350px;
          word-wrap: break-word;
        `;

        if (type === "success") {
          notification.style.background = "#d4edda";
          notification.style.color = "#155724";
          notification.style.border = "1px solid #c3e6cb";
        } else if (type === "error") {
          notification.style.background = "#f8d7da";
          notification.style.color = "#721c24";
          notification.style.border = "1px solid #f5c6cb";
        } else {
          notification.style.background = "#d1ecf1";
          notification.style.color = "#0c5460";
          notification.style.border = "1px solid #bee5eb";
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 4000);
      }

      // Function to handle quiz access with prerequisite checks
      function handleQuizAccess(subject, subtopic) {
        fetch(`/api/quiz-prerequisites/${subject}/${subtopic}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.all_met) {
              // Prerequisites met or admin override active, redirect to quiz
              window.location.href = `/quiz/${subject}/${subtopic}`;
            } else {
              // Prerequisites not met, show warning and redirect to prerequisites page
              const missingCount = data.missing_items.length;
              const message =
                missingCount > 0
                  ? `You still need to complete ${missingCount} requirement(s):\n\n• ${data.missing_items.join(
                      "\n• "
                    )}`
                  : "Please review the lesson content before attempting the quiz.";

              alert(
                message + "\n\nWe'll open the lessons so you can finish up."
              );
              showInitialLessons(subject, subtopic);
            }
          })
          .catch((error) => {
            console.error("Error checking quiz prerequisites:", error);
            // On error, allow quiz access (fallback)
            window.location.href = `/quiz/${subject}/${subtopic}`;
          });
      }

      // Update quiz button status based on prerequisites
      function updateQuizButtonStatus(subjectOverride, subtopicOverride) {
        const subject = subjectOverride || "{{ subject }}";
        const subtopic = subtopicOverride;

        if (!subject || !subtopic) {
          return;
        }

        fetch(`/api/quiz-prerequisites/${subject}/${subtopic}`)
          .then((response) => response.json())
          .then((data) => {
            applyLessonQuizButtonState({ ...data, subject, subtopic });
            const allMet = data.admin_override || data.all_met;
            updateRequirementsDisplay(subtopic, data, allMet);
          })
          .catch((error) => {
            console.error(
              `Error checking prerequisites for ${subtopic}:`,
              error
            );
            const fallbackData = {
              subject,
              subtopic,
              admin_override: false,
              has_prerequisites: false,
              all_met: true,
              lessons_complete: true,
              videos_complete: true,
              missing_items: [],
            };
            applyLessonQuizButtonState(fallbackData);
            updateRequirementsDisplay(subtopic, fallbackData, true);
          });
      }

      // Update the requirements display
      function updateRequirementsDisplay(subtopic, data, allMet) {
        const containers = [];
        const subtopicRequirements = document.getElementById(
          `quiz-requirements-${subtopic}`
        );
        if (subtopicRequirements) {
          containers.push(subtopicRequirements);
        }

        const lessonRequirements = document.getElementById(
          "lesson-quiz-requirements"
        );
        if (
          lessonRequirements &&
          lessonRequirements.dataset.hasQuiz !== "false" &&
          lessonRequirements.dataset.subject === data.subject &&
          lessonRequirements.dataset.subtopic === data.subtopic
        ) {
          containers.push(lessonRequirements);
        }

        if (containers.length === 0) return;

        const lessonsComplete = !!data.lessons_complete;
        const videosComplete =
          typeof data.videos_complete === "boolean"
            ? data.videos_complete
            : (data.videos_total || 0) === 0 ||
              (data.videos_watched || 0) >= (data.videos_total || 0);

        const missingLessonsCount = Array.isArray(data.missing_lessons)
          ? data.missing_lessons.length
          : 0;
        const lessonsCompletedCountRaw =
          typeof data.lessons_completed === "number"
            ? data.lessons_completed
            : lessonsComplete
            ? data.lesson_total || 0
            : (data.lesson_total || 0) - missingLessonsCount;
        const lessonsCompletedCount = Math.max(0, lessonsCompletedCountRaw);
        const lessonsTotal = data.lesson_total || 0;

        const missingVideosCount = Array.isArray(data.missing_videos)
          ? data.missing_videos.length
          : 0;
        const videosWatchedCountRaw =
          typeof data.videos_watched === "number"
            ? data.videos_watched
            : videosComplete
            ? data.videos_total || 0
            : (data.videos_total || 0) - missingVideosCount;
        const videosWatchedCount = Math.max(0, videosWatchedCountRaw);
        const videosTotal = data.videos_total || 0;

        const adminOverrideActive = !!data.admin_override;

        containers.forEach((container) => {
          container.style.display = allMet ? "none" : "block";

          const lessonsStatus = container.querySelector(".lessons-status");
          if (lessonsStatus) {
            const lessonStatusClass = lessonsComplete
              ? "complete"
              : adminOverrideActive
              ? "admin-override"
              : "incomplete";
            lessonsStatus.className = `req-status ${lessonStatusClass}`;

            if (lessonsTotal === 0) {
              lessonsStatus.textContent = "No lessons";
            } else {
              const lessonsSummary = `${lessonsCompletedCount}/${lessonsTotal}`;
              lessonsStatus.textContent = lessonsComplete
                ? `${lessonsSummary} ✓`
                : lessonsSummary;
            }
          }

          const videoStatus = container.querySelector(".video-status");
          if (videoStatus) {
            const videoStatusClass = videosComplete
              ? "complete"
              : adminOverrideActive
              ? "admin-override"
              : "incomplete";
            videoStatus.className = `req-status ${videoStatusClass}`;

            if (videosTotal === 0) {
              videoStatus.textContent = "No videos";
            } else {
              const videosSummary = `${videosWatchedCount}/${videosTotal}`;
              videoStatus.textContent = videosComplete
                ? `${videosSummary} ✓`
                : videosSummary;
            }
          }

          const lessonsIcon = container.querySelector(".lessons-icon");
          if (lessonsIcon) {
            lessonsIcon.className = "req-icon lessons-icon fas fa-book";
          }

          const videoIcon = container.querySelector(".video-icon");
          if (videoIcon) {
            videoIcon.className = "req-icon video-icon fas fa-play";
          }
        });
      }

      // Update quiz button status for the active subtopic only
      if (currentSubject && currentSubtopic) {
        updateQuizButtonStatus(currentSubject, currentSubtopic);
      }
      setInterval(() => {
        if (currentSubject && currentSubtopic) {
          updateQuizButtonStatus(currentSubject, currentSubtopic);
        }
      }, 120000); // Check every 2 minutes

      // Pyodide functionality for code execution
      let pyodide = null;
      let pyodideLoading = false;

      async function initPyodide() {
        if (pyodide) return pyodide;
        if (pyodideLoading) {
          // Wait for existing initialization to complete
          while (pyodideLoading) {
            await new Promise((resolve) => setTimeout(resolve, 100));
          }
          return pyodide;
        }

        pyodideLoading = true;
        try {
          pyodide = await loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
          });
          console.log("Pyodide loaded successfully");
          return pyodide;
        } catch (error) {
          console.error("Failed to load Pyodide:", error);
          throw error;
        } finally {
          pyodideLoading = false;
        }
      }

      async function runPythonCode(blockId) {
        const codeElement = document.getElementById(`code-editor-${blockId}`);
        const outputElement = document.getElementById(`code-output-${blockId}`);
        const runButton = document.querySelector(
          `#code-runner-${blockId} .run-code-btn, #code-runner-modal-${blockId} .run-code-btn`
        );

        if (!codeElement || !outputElement) return;

        const code = codeElement.value;
        if (!code.trim()) {
          outputElement.textContent = "Please enter some Python code to run.";
          return;
        }

        // Update button state
        runButton.disabled = true;
        runButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Running...';
        outputElement.textContent = "Initializing Python environment...";

        try {
          // Initialize Pyodide if not already done
          const py = await initPyodide();

          // Capture stdout and setup input() workaround
          py.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()

# Enable input() to work in browser environment
from js import prompt
__builtins__.input = lambda msg="": str(prompt(msg) or "")
`);

          // Run the user's code
          try {
            py.runPython(code);

            // Get the output
            const output = py.runPython("sys.stdout.getvalue()");
            outputElement.textContent =
              output || "Code executed successfully (no output)";
            outputElement.className = "output-content success";
          } catch (pythonError) {
            outputElement.textContent = `Error: ${pythonError.message}`;
            outputElement.className = "output-content error";
          }
        } catch (error) {
          outputElement.textContent = `Failed to run code: ${error.message}`;
          outputElement.className = "output-content error";
        } finally {
          // Reset button state
          runButton.disabled = false;
          runButton.innerHTML = '<i class="fas fa-play"></i> Run Code';
        }
      }

      function clearOutput(blockId) {
        const outputElement = document.getElementById(`code-output-${blockId}`);
        if (outputElement) {
          outputElement.textContent = "";
          outputElement.className = "output-content";
        }
      }

      function calculateTokenCost(code) {
        const length = code ? code.length : 0;
        if (length <= 0) return 0;
        const rawTokens = length / 250;
        const rounded = Math.floor(rawTokens + 0.5);
        return Math.max(1, rounded);
      }

      function updateTokenBadge(balance) {
        const badge = document.getElementById("tokenBalanceBadge");
        const value = document.getElementById("tokenBalanceValue");
        if (!badge || !value) return;
        value.textContent = balance;
        badge.dataset.balance = balance;
      }

      let activeAiBlockId = null;

      function openAiAnalysisModal(blockId) {
        const modal = document.getElementById("aiAnalysisModal");
        const codeElement = document.getElementById(`code-editor-${blockId}`);
        if (!modal || !codeElement) return;

        const code = codeElement.value || "";
        const cost = calculateTokenCost(code);

        activeAiBlockId = blockId;

        const costEl = document.getElementById("aiAnalysisTokenCost");
        const balanceEl = document.getElementById("aiAnalysisTokenBalance");
        const previewEl = document.getElementById("aiAnalysisCodePreview");
        const errorEl = document.getElementById("aiAnalysisError");
        const resultEl = document.getElementById("aiAnalysisResult");
        const confirmBtn = document.getElementById("aiAnalysisConfirm");

        if (costEl) costEl.textContent = cost;
        if (balanceEl) balanceEl.textContent = currentTokenBalance;
        if (previewEl) previewEl.textContent = code || "(No code entered yet)";
        if (errorEl) errorEl.textContent = "";
        if (resultEl) resultEl.textContent = "";

        const insufficient = cost > currentTokenBalance || cost <= 0;
        if (confirmBtn) {
          confirmBtn.disabled = insufficient;
        }
        if (errorEl && insufficient) {
          errorEl.textContent = cost <= 0
            ? "Enter some code to analyze."
            : "Not enough tokens to run analysis.";
        }

        modal.classList.add("active");
      }

      function closeAiAnalysisModal() {
        const modal = document.getElementById("aiAnalysisModal");
        if (modal) {
          modal.classList.remove("active");
        }
        activeAiBlockId = null;
      }

      async function confirmAiAnalysis() {
        if (!activeAiBlockId) return;

        const codeElement = document.getElementById(
          `code-editor-${activeAiBlockId}`
        );
        if (!codeElement) return;

        const code = codeElement.value || "";
        const cost = calculateTokenCost(code);

        const resultEl = document.getElementById("aiAnalysisResult");
        const errorEl = document.getElementById("aiAnalysisError");
        const confirmBtn = document.getElementById("aiAnalysisConfirm");

        if (confirmBtn) {
          confirmBtn.disabled = true;
          confirmBtn.textContent = "Analyzing...";
        }
        if (errorEl) errorEl.textContent = "";
        if (resultEl) resultEl.textContent = "";

        try {
          const response = await fetch("/api/ai/code-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              code,
              allow_ai_analysis: true,
              subject: currentSubject,
              subtopic: currentSubtopic,
            }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "AI analysis failed.");
          }

          if (resultEl) {
            resultEl.textContent = data.analysis || "No feedback returned.";
          }
          currentTokenBalance = data.token_balance ?? currentTokenBalance - cost;
          updateTokenBadge(currentTokenBalance);
        } catch (err) {
          if (errorEl) {
            errorEl.textContent = err.message || "AI analysis failed.";
          }
        } finally {
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirm";
          }
        }
      }

      function showSolution(blockId) {
        const solutionElement = document.getElementById(`solution-${blockId}`);
        const button = document.querySelector(
          `#code-runner-${blockId} .show-solution-btn, #code-runner-modal-${blockId} .show-solution-btn`
        );

        if (solutionElement && button) {
          if (solutionElement.style.display === "none") {
            solutionElement.style.display = "block";
            button.innerHTML = '<i class="fas fa-lightbulb"></i> Hide Solution';
          } else {
            solutionElement.style.display = "none";
            button.innerHTML = '<i class="fas fa-lightbulb"></i> Show Solution';
          }
        }
      }

      function showHints(blockId) {
        const hintsElement = document.getElementById(`hints-${blockId}`);
        const button = document.querySelector(
          `#code-runner-${blockId} .show-hints-btn, #code-runner-modal-${blockId} .show-hints-btn`
        );

        if (hintsElement && button) {
          if (hintsElement.style.display === "none") {
            hintsElement.style.display = "block";
            button.innerHTML =
              '<i class="fas fa-question-circle"></i> Hide Hints';
          } else {
            hintsElement.style.display = "none";
            button.innerHTML =
              '<i class="fas fa-question-circle"></i> Show Hints';
          }
        }

        
      }

      // Add tab support to all textareas (especially for code editing)
      document.addEventListener("keydown", function (e) {
        // Handle Tab key in textareas
        if (e.target.tagName === "TEXTAREA" && e.key === "Tab") {
          e.preventDefault();

          const textarea = e.target;
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;

          // Insert 4 spaces (or a tab character) at cursor position
          const tab = "    "; // 4 spaces for Python indentation
          textarea.value =
            textarea.value.substring(0, start) +
            tab +
            textarea.value.substring(end);

          // Move cursor after the inserted tab
          textarea.selectionStart = textarea.selectionEnd = start + tab.length;
        }
      });
      // Code Runner Modal Functions - enhanced layout
      function expandCodeRunner(blockId) {
        const existingModal = document.getElementById(
          `code-runner-modal-${blockId}`
        );

        if (existingModal) {
          closeCodeRunnerModal(blockId);
        } else {
          openCodeRunnerModal(blockId);
        }
      }

      function setExpandButtonState(blockId, isExpanded) {
        const toggleBtn = document.querySelector(
          `#code-runner-${blockId} .code-runner-toggle`
        );

        if (!toggleBtn) {
          return;
        }

        toggleBtn.innerHTML = isExpanded
          ? '<i class="fas fa-compress-alt"></i>'
          : '<i class="fas fa-expand-alt"></i>';
        toggleBtn.setAttribute("aria-expanded", isExpanded ? "true" : "false");
        toggleBtn.setAttribute(
          "aria-label",
          isExpanded ? "Collapse code runner" : "Expand code runner"
        );
        toggleBtn.classList.toggle("is-expanded", isExpanded);
      }

      function collectCodeRunnerQuestion(originalBlock) {
        const fragments = [];
        let pointer = originalBlock.previousElementSibling;
        let steps = 0;

        while (pointer && steps < 3) {
          if (
            pointer.classList &&
            pointer.classList.contains("code-runner-block")
          ) {
            break;
          }

          if (!pointer.matches("p, ul, ol, h2, h3, h4, h5")) {
            break;
          }

          fragments.unshift(pointer.outerHTML);
          steps += 1;

          if (pointer.matches("h2, h3, h4, h5")) {
            break;
          }

          pointer = pointer.previousElementSibling;
        }

        return fragments.join("");
      }

      function openCodeRunnerModal(blockId) {
        const originalBlock = document.getElementById(`code-runner-${blockId}`);
        if (!originalBlock) {
          return;
        }

        const codeRunnerContent = originalBlock.querySelector(
          ".code-runner-content"
        );
        if (!codeRunnerContent) {
          return;
        }

        const modal = document.createElement("div");
        modal.className = "code-runner-modal active";
        modal.id = `code-runner-modal-${blockId}`;

        const modalContent = document.createElement("div");
        modalContent.className = "code-runner-modal-content";

        const header = document.createElement("div");
        header.className = "code-runner-modal-header";

        const title = document.createElement("h4");
        title.innerHTML =
          '<i class="fas fa-play-circle"></i> Interactive Python Code';

        const actions = document.createElement("div");
        actions.className = "code-runner-modal-actions";

        const collapseBtn = document.createElement("button");
        collapseBtn.type = "button";
        collapseBtn.className = "code-runner-modal-collapse";
        collapseBtn.innerHTML = '<i class="fas fa-compress-alt"></i> Collapse';
        collapseBtn.addEventListener("click", () =>
          closeCodeRunnerModal(blockId)
        );

        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "code-runner-modal-close";
        closeBtn.innerHTML = "&times;";
        closeBtn.addEventListener("click", () => closeCodeRunnerModal(blockId));

        actions.appendChild(collapseBtn);
        actions.appendChild(closeBtn);

        header.appendChild(title);
        header.appendChild(actions);

        const body = document.createElement("div");
        body.className = "code-runner-modal-body";

        const layout = document.createElement("div");
        layout.className = "code-runner-expanded-grid";

        const questionHTML = collectCodeRunnerQuestion(originalBlock);
        if (questionHTML) {
          const question = document.createElement("div");
          question.className = "code-runner-modal-question";
          question.innerHTML = questionHTML;
          layout.appendChild(question);
        } else {
          layout.classList.add("no-question");
        }

        const expectedOutput =
          codeRunnerContent.querySelector(".expected-output");
        const codeOutput = codeRunnerContent.querySelector(".code-output");
        const hintsElement = codeRunnerContent.querySelector(
          `#hints-${blockId}`
        );
        const solutionElement = codeRunnerContent.querySelector(
          `#solution-${blockId}`
        );

        const placeholder = document.createElement("div");
        placeholder.id = `code-runner-placeholder-${blockId}`;
        placeholder.className = "code-runner-placeholder";
        placeholder.innerHTML =
          '<i class="fas fa-external-link-alt"></i><span>Code runner is open in the expanded view</span>';

        originalBlock.insertBefore(placeholder, codeRunnerContent);

        codeRunnerContent.classList.add("code-runner-expanded");

        if (expectedOutput) {
          expectedOutput.classList.add("code-runner-modal-expected");
          layout.appendChild(expectedOutput);
        } else {
          layout.classList.add("no-expected");
        }

        const editorWrapper = document.createElement("div");
        editorWrapper.className = "code-runner-grid-editor";
        editorWrapper.appendChild(codeRunnerContent);
        layout.appendChild(editorWrapper);

        const outputWrapper = document.createElement("div");
        outputWrapper.className = "code-runner-grid-output";

        if (codeOutput) {
          outputWrapper.appendChild(codeOutput);
        }
        if (hintsElement) {
          outputWrapper.appendChild(hintsElement);
        }
        if (solutionElement) {
          outputWrapper.appendChild(solutionElement);
        }

        if (outputWrapper.childNodes.length > 0) {
          layout.appendChild(outputWrapper);
        } else {
          layout.classList.add("no-output");
        }

        body.appendChild(layout);

        modalContent.appendChild(header);
        modalContent.appendChild(body);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        modal._extractedElements = {
          expectedOutput,
          codeOutput,
          hintsElement,
          solutionElement,
        };

        const escHandler = (event) => {
          if (event.key === "Escape") {
            closeCodeRunnerModal(blockId);
          }
        };
        document.addEventListener("keydown", escHandler);

        const outsideClickHandler = (event) => {
          if (event.target === modal) {
            closeCodeRunnerModal(blockId);
          }
        };
        modal.addEventListener("click", outsideClickHandler);

        modal._escapeHandler = escHandler;
        modal._outsideClickHandler = outsideClickHandler;

        setExpandButtonState(blockId, true);
      }

      function closeCodeRunnerModal(blockId) {
        const modal = document.getElementById(`code-runner-modal-${blockId}`);
        const originalBlock = document.getElementById(`code-runner-${blockId}`);
        const placeholder = document.getElementById(
          `code-runner-placeholder-${blockId}`
        );

        const codeRunnerContent = modal
          ? modal.querySelector(".code-runner-content")
          : originalBlock
          ? originalBlock.querySelector(".code-runner-content")
          : null;

        const extracted = modal ? modal._extractedElements || {} : {};

        if (codeRunnerContent) {
          const { codeOutput, expectedOutput, hintsElement, solutionElement } =
            extracted;

          if (codeOutput && !codeRunnerContent.contains(codeOutput)) {
            codeRunnerContent.appendChild(codeOutput);
          }

          if (expectedOutput && !codeRunnerContent.contains(expectedOutput)) {
            expectedOutput.classList.remove("code-runner-modal-expected");
            codeRunnerContent.appendChild(expectedOutput);
          }

          if (hintsElement && !codeRunnerContent.contains(hintsElement)) {
            codeRunnerContent.appendChild(hintsElement);
          }

          if (solutionElement && !codeRunnerContent.contains(solutionElement)) {
            codeRunnerContent.appendChild(solutionElement);
          }
        }

        if (codeRunnerContent && originalBlock) {
          codeRunnerContent.classList.remove("code-runner-expanded");
          if (placeholder && originalBlock.contains(placeholder)) {
            originalBlock.insertBefore(codeRunnerContent, placeholder);
          } else {
            originalBlock.appendChild(codeRunnerContent);
          }
        }

        if (placeholder && placeholder.parentNode) {
          placeholder.remove();
        }

        if (modal) {
          if (modal._escapeHandler) {
            document.removeEventListener("keydown", modal._escapeHandler);
          }
          if (modal._outsideClickHandler) {
            modal.removeEventListener("click", modal._outsideClickHandler);
          }
          delete modal._extractedElements;
          modal.remove();
        }

        setExpandButtonState(blockId, false);
      }
    </script>

    <div id="aiAnalysisModal" class="ai-analysis-modal" aria-hidden="true">
      <div class="ai-analysis-modal-content" role="dialog" aria-modal="true">
        <div class="ai-analysis-header">
          <h3><i class="fas fa-robot"></i> AI Analysis</h3>
          <button class="ai-analysis-close" type="button" onclick="closeAiAnalysisModal()">
            &times;
          </button>
        </div>
        <div class="ai-analysis-body">
          <p>
            Your code will be sent to the AI tutor for feedback. This will cost
            <strong><span id="aiAnalysisTokenCost">0</span> tokens</strong>.
            You have <strong><span id="aiAnalysisTokenBalance">0</span></strong>.
          </p>
          <div class="ai-analysis-preview">
            <label>Code preview</label>
            <pre id="aiAnalysisCodePreview"></pre>
          </div>
          <div id="aiAnalysisError" class="ai-analysis-error"></div>
          <div class="ai-analysis-result" id="aiAnalysisResult"></div>
        </div>
        <div class="ai-analysis-actions">
          <button class="btn-secondary" type="button" onclick="closeAiAnalysisModal()">Cancel</button>
          <button class="btn-primary" id="aiAnalysisConfirm" type="button" onclick="confirmAiAnalysis()">Confirm</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  </body>
</html>
