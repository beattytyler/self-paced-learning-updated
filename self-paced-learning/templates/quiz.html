<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ quiz_title or "Quiz" }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Pyodide for Python code execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  </head>
  <body class="quiz-page">
    {% if admin_override %}
    <div class="admin-controls-floating">
      <div class="admin-override-panel">
        <div class="admin-override-label">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Override Active</span>
        </div>
      </div>
    </div>
    {% endif %} {% if admin_override %}
    <div class="admin-override-notice">
      <i class="fas fa-exclamation-triangle"></i>
      <strong>Admin Override Active:</strong> Correct answers are highlighted in
      green for testing purposes.
    </div>
    {% endif %}

    <h1>{{ quiz_title or "Quiz" }}</h1>

    {% if token_balance is not none %}
    <div
      class="token-badge quiz-token-badge"
      id="tokenBalanceBadge"
      data-balance="{{ token_balance }}"
    >
      <i class="fas fa-coins"></i>
      <span id="tokenBalanceValue">{{ token_balance }}</span>
    </div>
    {% endif %} {% if ai_feedback %}
    <div class="ai-feedback-banner">
      <div class="ai-feedback-icon">
        <i class="fas fa-robot"></i>
      </div>
      <div class="ai-feedback-content">
        <h3>AI Learning Assistant</h3>
        <p>{{ ai_feedback }}</p>
      </div>
    </div>
    {% endif %}

    <form id="quiz-form" class="quiz-form">
      {% for q in questions %} {% set idx = loop.index0 %}
      <div class="question">
        <p>
          <strong
            >{{ loop.index }}. {# Check if the question is fill-in-the-blank to
            render the input inline #} {% if q.type == 'fill_in_the_blank' %} {{
            q.question.split('____')[0] | safe }}
            <input
              type="text"
              name="q{{ idx }}"
              class="inline-input"
              required
              autocomplete="off"
            />
            {{ q.question.split('____')[1] | safe }}
            <span class="question-type-indicator fill-blank"
              >Fill in Blank</span
            >
            {% elif q.type == 'short_answer' %} {{ q.question }}
            <span class="question-type-indicator short-answer"
              >Short Answer</span
            >
            {% elif q.type == 'coding' %} {{ q.question }}
            <span class="question-type-indicator coding">Coding</span>
            {% else %} {# Otherwise, display the question text normally for
            multiple choice #} {{ q.question }}
            <span class="question-type-indicator multiple-choice"
              >Multiple Choice</span
            >
            {% endif %}
          </strong>
        </p>

        {# --- ADDITIONAL CONTENT (paragraphs and code blocks) --- #} {% if
        q.content %}
        <div class="question-content">
          {% for block in q.content %} {% if block.type == 'paragraph' %}
          <p class="content-paragraph">{{ block.text }}</p>
          {% elif block.type == 'code' %}
          <pre class="content-code"><code>{{ block.text }}</code></pre>
          {% endif %} {% endfor %}
        </div>
        {% endif %} {# --- MULTIPLE CHOICE (default if no type specified) --- #}
        {% if q.type == 'multiple_choice' or not q.type %} {% for option in
        q.options %}
        <label
          class="{% if admin_override and loop.index0 == q.answer_index %}correct-answer{% endif %}"
        >
          <input type="radio" name="q{{ idx }}" value="{{ option }}" required />
          {{ option }} {% if admin_override and loop.index0 == q.answer_index %}
          <i class="fas fa-check-circle correct-indicator"></i>
          {% endif %}
        </label>
        {% endfor %} {# --- CODING QUESTION --- #} {% elif q.type == 'coding' %}
        <div class="code-runner-block" id="code-runner-q{{ idx }}">
          <div class="code-runner-content">
            <div class="code-editor">
              <textarea
                id="code-editor-q{{ idx }}"
                name="q{{ idx }}"
                class="python-editor"
                placeholder="Write your Python code here..."
                required
              >
{{ q.starter_code or '' }}</textarea
              >
            </div>
            <div class="code-controls">
              <button
                type="button"
                class="run-code-btn"
                onclick="runPythonCodeInQuiz('q{{ idx }}')"
              >
                <i class="fas fa-play"></i> Test Your Code
              </button>
              <button
                type="button"
                class="clear-output-btn"
                onclick="clearOutputInQuiz('q{{ idx }}')"
              >
                <i class="fas fa-trash"></i> Clear Output
              </button>
              {% if q.allow_ai_analysis is not defined or q.allow_ai_analysis %}
              <button
                type="button"
                class="ai-analysis-btn"
                onclick="openQuizAiAnalysisModal('q{{ idx }}', {{ idx }})"
              >
                <i class="fas fa-robot"></i> AI Analysis
              </button>
              {% endif %}
            </div>
            <div class="code-output">
              <div class="output-header">Test Output:</div>
              <pre id="code-output-q{{ idx }}" class="output-content"></pre>
            </div>
            {% if q.sample_solution %}
            <div class="sample-solution-hint">
              <small
                ><i class="fas fa-info-circle"></i> You can test your code
                before submitting. Your final code will be submitted when you
                click "Submit Quiz".</small
              >
            </div>
            {% endif %}
          </div>
        </div>

        {# --- SHORT ANSWER QUESTION --- #} {% elif q.type == 'short_answer' %}
        <textarea
          name="q{{ idx }}"
          rows="5"
          placeholder="Type your answer here...{% if q.min_words %} (Minimum {{ q.min_words }} words){% endif %}"
          required
        ></textarea>
        {% if q.min_words %}
        <small class="word-count-hint"
          >Minimum {{ q.min_words }} words required</small
        >
        {% endif %} {# --- FILL IN THE BLANK --- #} {% elif q.type ==
        'fill_in_the_blank' %} {# Fill-in-the-blank input is already handled
        above in the question text #} {% endif %}
      </div>
      {% endfor %}
      <button type="submit" class="quiz-submit-button">Submit Quiz</button>
    </form>

    <script>
            // Add click handlers for visual feedback
            document.addEventListener("DOMContentLoaded", function () {
              // Add click event listeners to all labels
              const labels = document.querySelectorAll(".question label");
              labels.forEach((label) => {
                label.addEventListener("click", function () {
                  // Find the question container
                  const questionDiv = this.closest(".question");

                  // Remove selected class from all labels in this question
                  questionDiv.querySelectorAll("label").forEach((l) => {
                    l.classList.remove("selected");
                  });

                  // Add selected class to clicked label
                  this.classList.add("selected");
                });
              });
            });

            document
              .getElementById("quiz-form")
              .addEventListener("submit", async function (e) {
                e.preventDefault();

                // Get the submit button and disable it immediately
                const submitButton = e.target.querySelector(".quiz-submit-button");
                const originalText = submitButton.textContent;

                // Disable button and show processing state
                submitButton.disabled = true;
                submitButton.textContent = "Submitting...";
                submitButton.classList.add("disabled");

                const formData = new FormData(e.target);
                const responses = {};

                for (const [name, value] of formData.entries()) {
                  responses[name] = value;
                }

                try {
                  // Submit answers to analyze route - Flask session will handle data persistence
                  const analyzeResponse = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ answers: responses }),
                  });

                  if (analyzeResponse.ok) {
                    // Analysis complete - redirect to results (data is in Flask session)
                    window.location.href = "/results";
                  } else {
                    console.error("Analysis failed:", analyzeResponse.status);
                    alert("Quiz analysis failed. Please try again.");
                    // Re-enable button on error
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                    submitButton.classList.remove("disabled");
                  }
                } catch (error) {
                  console.error("Error during analysis:", error);
                  alert("Error submitting quiz. Please try again.");
                  // Re-enable button on error
                  submitButton.disabled = false;
                  submitButton.textContent = originalText;
                  submitButton.classList.remove("disabled");
                }
              });

            // Pyodide functionality for code execution in quiz
            let pyodide = null;
            let pyodideLoading = false;
        const initialTokenBalance = {{ token_balance if token_balance is not none else 0 }};
        let currentTokenBalance = initialTokenBalance;
        let activeQuizAiQuestionIndex = null;

            async function initPyodide() {
              if (pyodide) return pyodide;
              if (pyodideLoading) {
                // Wait for existing initialization to complete
                while (pyodideLoading) {
                  await new Promise((resolve) => setTimeout(resolve, 100));
                }
                return pyodide;
              }

              pyodideLoading = true;
              try {
                pyodide = await loadPyodide({
                  indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
                });
                console.log("Pyodide loaded successfully");
                return pyodide;
              } catch (error) {
                console.error("Failed to load Pyodide:", error);
                throw error;
              } finally {
                pyodideLoading = false;
              }
            }

            async function runPythonCodeInQuiz(questionId) {
              const codeElement = document.getElementById(
                `code-editor-${questionId}`
              );
              const outputElement = document.getElementById(
                `code-output-${questionId}`
              );
              const runButton = document.querySelector(
                `#code-runner-${questionId} .run-code-btn`
              );

              if (!codeElement || !outputElement) return;

              const code = codeElement.value;
              if (!code.trim()) {
                outputElement.textContent = "Please enter some Python code to run.";
                outputElement.className = "output-content";
                return;
              }

              // Update button state
              runButton.disabled = true;
              runButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Running...`;
              outputElement.textContent = "Initializing Python environment...";
              outputElement.className = "output-content";

              try {
                // Initialize Pyodide if not already done
                const py = await initPyodide();

                // Capture stdout and setup input() workaround
                py.runPython(`
      import sys
      from io import StringIO
      sys.stdout = StringIO()

      # Enable input() to work in browser environment
      from js import prompt
      __builtins__.input = lambda msg="": str(prompt(msg) or "")
      `);

                // Run the user's code
                try {
                  py.runPython(code);

                  // Get the output
                  const output = py.runPython("sys.stdout.getvalue()");
                  outputElement.textContent =
                    output || "Code executed successfully (no output)";
                  outputElement.className = "output-content success";
                } catch (pythonError) {
                  outputElement.textContent = `Error: ${pythonError.message}`;
                  outputElement.className = "output-content error";
                }
              } catch (error) {
                outputElement.textContent = `Failed to initialize Python environment: ${error.message}`;
                outputElement.className = "output-content error";
              } finally {
                // Re-enable button
                runButton.disabled = false;
                runButton.innerHTML = '<i class="fas fa-play"></i> Test Your Code';
              }
            }

            function clearOutputInQuiz(questionId) {
              const outputElement = document.getElementById(
                `code-output-${questionId}`
              );
              if (outputElement) {
                outputElement.textContent = "";
                outputElement.className = "output-content";
              }
            }

            function calculateTokenCost(code) {
              const length = code ? code.length : 0;
              if (length <= 0) return 0;
              const rawTokens = length / 250;
              const rounded = Math.floor(rawTokens + 0.5);
              return Math.max(1, rounded);
            }

            function updateTokenBadge(balance) {
              const badge = document.getElementById("tokenBalanceBadge");
              const value = document.getElementById("tokenBalanceValue");
              if (!badge || !value) return;
              value.textContent = balance;
              badge.dataset.balance = balance;
            }

            function openQuizAiAnalysisModal(questionId, questionIndex) {
              const modal = document.getElementById("aiAnalysisModal");
              const codeElement = document.getElementById(`code-editor-${questionId}`);
              if (!modal || !codeElement) return;

              const code = codeElement.value || "";
              const cost = calculateTokenCost(code);

              activeQuizAiQuestionIndex = questionIndex;

              document.getElementById("aiAnalysisTokenCost").textContent = cost;
              document.getElementById("aiAnalysisTokenBalance").textContent = currentTokenBalance;
              document.getElementById("aiAnalysisCodePreview").textContent = code || "(No code entered yet)";
              document.getElementById("aiAnalysisError").textContent = "";
              document.getElementById("aiAnalysisResult").textContent = "";

              const confirmBtn = document.getElementById("aiAnalysisConfirm");
              const insufficient = cost > currentTokenBalance || cost <= 0;
              confirmBtn.disabled = insufficient;
              if (insufficient) {
                document.getElementById("aiAnalysisError").textContent = cost <= 0
                  ? "Enter some code to analyze."
                  : "Not enough tokens to run analysis.";
              }

              modal.classList.add("active");
            }

            function closeAiAnalysisModal() {
              const modal = document.getElementById("aiAnalysisModal");
              if (modal) {
                modal.classList.remove("active");
              }
              activeQuizAiQuestionIndex = null;
            }

            async function confirmAiAnalysis() {
              if (activeQuizAiQuestionIndex === null) return;

              const questionId = `q${activeQuizAiQuestionIndex}`;
              const codeElement = document.getElementById(`code-editor-${questionId}`);
              if (!codeElement) return;

              const code = codeElement.value || "";
              const cost = calculateTokenCost(code);

              const confirmBtn = document.getElementById("aiAnalysisConfirm");
              const errorEl = document.getElementById("aiAnalysisError");
              const resultEl = document.getElementById("aiAnalysisResult");

              confirmBtn.disabled = true;
              confirmBtn.textContent = "Analyzing...";
              errorEl.textContent = "";
              resultEl.textContent = "";

              try {
                const response = await fetch("/api/ai/code-analysis", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    code,
                    question_index: activeQuizAiQuestionIndex,
                  }),
                });

                const data = await response.json();
                if (!response.ok) {
                  throw new Error(data.error || "AI analysis failed.");
                }

                resultEl.textContent = data.analysis || "No feedback returned.";
                currentTokenBalance = data.token_balance ?? currentTokenBalance - cost;
                updateTokenBadge(currentTokenBalance);
              } catch (err) {
                errorEl.textContent = err.message || "AI analysis failed.";
              } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = "Confirm";
              }
            }
    </script>

    <style>
      /* Correct answer highlighting */
      .correct-answer {
        background-color: #d4edda !important;
        border: 2px solid #28a745 !important;
        color: #155724 !important;
        position: relative;
      }

      .correct-answer:hover {
        background-color: #c3e6cb !important;
      }

      .correct-indicator {
        color: #28a745;
        margin-left: 10px;
        font-size: 1.1em;
      }

      .admin-override-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .admin-override-notice i {
        color: #ffc107;
        font-size: 1.2em;
      }

      /* Disabled button styles */
      .quiz-submit-button.disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #ffffff !important;
        cursor: not-allowed !important;
        opacity: 0.65 !important;
        pointer-events: none !important;
      }

      .quiz-submit-button:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        color: #ffffff !important;
        cursor: not-allowed !important;
        opacity: 0.65 !important;
        pointer-events: none !important;
      }

      /* Code runner styles */
      .code-runner-block {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
      }

      .code-runner-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .code-editor {
        width: 100%;
      }

      .python-editor {
        width: 100%;
        min-height: 200px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: #fff;
        resize: vertical;
      }

      .code-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .run-code-btn,
      .clear-output-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .run-code-btn {
        background: #28a745;
        color: white;
      }

      .run-code-btn:hover:not(:disabled) {
        background: #218838;
      }

      .run-code-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
      }

      .clear-output-btn {
        background: #6c757d;
        color: white;
      }

      .clear-output-btn:hover {
        background: #5a6268;
      }

      .code-output {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 12px;
      }

      .output-header {
        font-weight: bold;
        color: #495057;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .output-content {
        font-family: "Courier New", monospace;
        font-size: 13px;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: #000;
        min-height: 60px;
      }

      .output-content.success {
        color: #155724;
        background: #d4edda;
        padding: 8px;
        border-radius: 4px;
      }

      .output-content.error {
        color: #721c24;
        background: #f8d7da;
        padding: 8px;
        border-radius: 4px;
      }

      .sample-solution-hint {
        margin-top: 8px;
        padding: 8px;
        background: #e7f3ff;
        border-left: 3px solid #007bff;
        border-radius: 4px;
      }

      .sample-solution-hint small {
        color: #004085;
        font-size: 13px;
      }
    </style>

    <div id="aiAnalysisModal" class="ai-analysis-modal" aria-hidden="true">
      <div class="ai-analysis-modal-content" role="dialog" aria-modal="true">
        <div class="ai-analysis-header">
          <h3><i class="fas fa-robot"></i> AI Analysis</h3>
          <button
            class="ai-analysis-close"
            type="button"
            onclick="closeAiAnalysisModal()"
          >
            &times;
          </button>
        </div>
        <div class="ai-analysis-body">
          <p>
            Your code will be sent to the AI tutor for feedback. This will cost
            <strong><span id="aiAnalysisTokenCost">0</span> tokens</strong>. You
            have <strong><span id="aiAnalysisTokenBalance">0</span></strong
            >.
          </p>
          <div class="ai-analysis-preview">
            <label>Code preview</label>
            <pre id="aiAnalysisCodePreview"></pre>
          </div>
          <div id="aiAnalysisError" class="ai-analysis-error"></div>
          <div class="ai-analysis-result" id="aiAnalysisResult"></div>
        </div>
        <div class="ai-analysis-actions">
          <button
            class="btn-secondary"
            type="button"
            onclick="closeAiAnalysisModal()"
          >
            Cancel
          </button>
          <button
            class="btn-primary"
            id="aiAnalysisConfirm"
            type="button"
            onclick="confirmAiAnalysis()"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
